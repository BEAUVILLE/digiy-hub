<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#061b14"/>
  <title>DIGIY ‚Äî Temp√©rature Business (PRO)</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- DIGIY Guard (universel) -->
  <script src="./guard.js?v=1"></script>

  <style>
    :root{
      --bg:#061b14;
      --card:#0b2a1f;
      --line:rgba(255,255,255,.12);
      --text:#eafff1;
      --muted:rgba(234,255,241,.7);

      --gold:#facc15;
      --green:#22c55e;
      --orange:#f59e0b;
      --red:#ef4444;

      --radius:20px;
      --shadow:0 12px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,sans-serif;
      background:
        radial-gradient(circle at 20% 10%, rgba(250,204,21,.12), transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }
    .wrap{max-width:1120px;margin:0 auto}

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px;
    }
    .logo{
      font-size:28px;
      font-weight:900;
      color:var(--gold);
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .status{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:13px;
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }

    .topActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin:10px 0 12px;
      flex-wrap:wrap;
    }
    .linkBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:var(--text);
      text-decoration:none;
      font-weight:950;
      font-size:13px;
      transition: transform .08s ease, opacity .08s ease;
      cursor:pointer;
    }
    .linkBtn:active{transform:translateY(1px); opacity:.92}

    .panel{
      border:1px solid rgba(250,204,21,.22);
      background:rgba(250,204,21,.07);
      border-radius:18px;
      padding:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.25);
      margin:10px 0 14px;
      display:none;
    }
    .panel h2{
      font-size:14px;
      font-weight:950;
      color:var(--gold);
      letter-spacing:.2px;
      margin-bottom:8px;
    }
    .panel p{
      font-size:13px;
      color:rgba(234,255,241,.78);
      line-height:1.55;
    }
    .panel code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      padding:2px 6px;
      border-radius:10px;
      color:rgba(234,255,241,.92);
    }

    .urgentBar{
      display:none;
      margin:10px 0 14px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(239,68,68,.55);
      background:rgba(239,68,68,.12);
      box-shadow:var(--shadow);
    }
    .urgentRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .urgentTitle{ font-weight:950; font-size:15px; }
    .urgentText{ font-size:13px; opacity:.9; margin-top:4px; }
    .urgentBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
      transition: transform .08s ease, opacity .08s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .urgentBtn:active{transform:translateY(1px); opacity:.92}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
    }
    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .titleRow{
      font-size:16px;
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .dueBadge{
      display:none;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      border:1px solid rgba(239,68,68,.65);
      background:rgba(239,68,68,.14);
    }
    @keyframes digiyPulse{
      0%   { transform: scale(1);    box-shadow:0 0 0 rgba(239,68,68,0); }
      50%  { transform: scale(1.04); box-shadow:0 0 22px rgba(239,68,68,.22); }
      100% { transform: scale(1);    box-shadow:0 0 0 rgba(239,68,68,0); }
    }
    .duePulse{ animation: digiyPulse 1.05s ease-in-out infinite; }

    @media (prefers-reduced-motion: reduce){
      .duePulse{ animation:none !important; }
      .urgentBtn{ transition:none !important; }
      .linkBtn{ transition:none !important; }
    }

    .value{
      font-size:46px;
      font-weight:950;
      margin:8px 0;
      color:var(--gold);
      line-height:1;
    }
    .hint{
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }

    .tempBox{
      margin-top:14px;
      padding:16px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      text-align:center;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
    }
    .temp{
      font-size:28px;
      font-weight:950;
      margin-top:8px;
    }
    .subTemp{
      margin-top:6px;
      font-size:12px;
      color:rgba(234,255,241,.55);
      line-height:1.35;
    }

    .miniRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:rgba(234,255,241,.78);
      font-weight:800;
    }

    footer{
      margin-top:18px;
      text-align:center;
      font-size:12px;
      color:rgba(234,255,241,.35);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo">‚ôæÔ∏è DIGIY</div>
      <div class="status" id="status" aria-live="polite">V√©rification‚Ä¶</div>
    </header>

    <div class="topActions">
      <a class="linkBtn" id="hubLink" href="./">üè† HUB</a>
      <a class="linkBtn" id="pulseLink" href="./pulse.html">üì¨ Pulse</a>
      <a class="linkBtn" id="refreshBtn" href="#">üîÑ Rafra√Æchir</a>
      <a class="linkBtn" id="logoutBtn" href="#">üö™ D√©connexion</a>
    </div>

    <div class="panel" id="swarmPanel">
      <h2>ü¶Ö DIGIY SWARM CORE ‚Äî TEMP√âRATURE BUSINESS</h2>
      <p>
        Ici c'est <b>PRO</b> : acc√®s prot√©g√© par <code>guard.js</code>.
        La Temp√©rature affiche l'√©tat r√©el de tes modules : workers actifs, pulses en attente, alertes syst√®me.
        <br><br>
        <b>Pierre par pierre</b>, le rail de l'infini se construit. üõ§Ô∏è‚àû
      </p>
    </div>

    <div class="urgentBar" id="urgentBar">
      <div class="urgentRow">
        <div>
          <div class="urgentTitle">üö® Action urgente</div>
          <div class="urgentText" id="urgentText">‚Äî</div>
        </div>
        <a class="urgentBtn" id="urgentBtn" href="./">Voir</a>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="cardActivity">
        <div class="titleRow">
          üìà Activit√© <span class="dueBadge" id="badgeActivityDue">D√õ</span>
        </div>
        <div class="value" id="kpiActivity">‚Äî</div>
        <div class="hint">Workers actifs / Modules en ligne</div>
      </div>

      <div class="card" id="cardAlerts">
        <div class="titleRow">
          üö® Alertes <span class="dueBadge" id="badgeAlertsDue">D√õ</span>
        </div>
        <div class="value" id="kpiAlerts">‚Äî</div>
        <div class="hint">Pulses failed (‚â•3 attempts)</div>
      </div>

      <div class="card" id="cardPulse">
        <div class="titleRow">
          üì¨ Pulse <span class="dueBadge" id="badgePulseDue">D√õ</span>
        </div>
        <div class="value" id="kpiPulse">‚Äî</div>
        <div class="hint">Pulses en attente (pending)</div>
      </div>

      <div class="card" id="cardScore">
        <div class="titleRow">
          ü¶Ö Score Swarm <span class="dueBadge" id="badgeScoreDue">D√õ</span>
        </div>
        <div class="value" id="kpiScore">‚Äî</div>
        <div class="hint">Sant√© globale (0‚Äì100)</div>
      </div>
    </div>

    <div class="tempBox">
      <div class="hint">üå°Ô∏è Temp√©rature Business</div>
      <div class="temp" id="tempTxt">‚Äî</div>
      <div class="subTemp" id="subTemp">‚Äî</div>
      <div class="miniRow">
        <div class="chip" id="chipSlug">slug: ‚Äî</div>
        <div class="chip" id="chipRole">role: ‚Äî</div>
        <div class="chip" id="chipUser">user: ‚Äî</div>
      </div>
    </div>

    <footer>‚ôæÔ∏è DIGIY ‚Äî 0% commission ‚Ä¢ Paiement direct ‚Ä¢ Souverainet√©</footer>
  </div>

<script>
/* =========================================================
   DIGIY ‚Äî Temperature-Business.html v2.0 (PRO)
   ‚úÖ Prot√©g√© par guard.js
   ‚úÖ Slug propagation + liens safe
   ‚úÖ KPIs R√âELS branch√©s sur Supabase RPC
   ü¶Ö Pierre par pierre, le rail de l'infini
   ========================================================= */

(function(){
  const $ = (id)=>document.getElementById(id);

  function safeText(id, txt){
    const el = $(id);
    if(el) el.textContent = (txt === undefined || txt === null) ? "‚Äî" : String(txt);
  }

  function setStatus(txt){
    safeText("status", txt);
  }

  function getSlug(){
    try{
      const s = new URL(location.href).searchParams.get("slug");
      if(s && String(s).trim()) return String(s).trim().toLowerCase();
    }catch(e){}
    try{
      const ls = localStorage.getItem("digiy_slug") || localStorage.getItem("slug");
      if(ls && String(ls).trim()) return String(ls).trim().toLowerCase();
    }catch(e){}
    return "";
  }

  function withSlug(href, slug){
    try{
      const u = new URL(href, location.href);
      if(slug) u.searchParams.set("slug", slug);
      return u.toString();
    }catch(e){ return href; }
  }

  function setDue(cardId, badgeId, isDue){
    const card = $(cardId);
    const badge = $(badgeId);
    if(!card || !badge) return;
    badge.style.display = isDue ? "inline-flex" : "none";
    card.classList.toggle("duePulse", !!isDue);
  }

  function showUrgent(text, href){
    const bar = $("urgentBar");
    const t   = $("urgentText");
    const b   = $("urgentBtn");
    if(!bar || !t || !b) return;
    t.textContent = text || "‚Äî";
    b.href = href || "./";
    bar.style.display = "block";
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function scoreToTemp(score){
    if(score >= 80) return { label:"üî• CHAUD", hint:"Machine qui tourne. Tu peux scaler.", due:false };
    if(score >= 55) return { label:"üå§Ô∏è TI√àDE", hint:"OK mais y'a des r√©glages √† faire.", due:false };
    if(score >= 35) return { label:"üå•Ô∏è FROID", hint:"Activit√© faible ou alertes. On relance le moteur.", due:true };
    return { label:"üßä GLAC√â", hint:"Urgence: action terrain + v√©rif syst√®me.", due:true };
  }

  // ü¶Ö FONCTION BRANCH√âE SUR VRAIES DONN√âES
  async function fetchKPIs(sb, ctx){
    try {
      // Appel RPC vers get_all_modules_status
      const { data: modules, error } = await sb.rpc('get_all_modules_status');
      
      if(error) {
        console.error('ü¶Ö RPC error:', error);
        throw error;
      }

      console.log('ü¶Ö Modules status:', modules);
      
      // Transformer en objet stats
      const stats = {};
      modules?.forEach(m => {
        stats[m.module] = {
          alive: m.worker_alive,
          pending: Number(m.pulses_pending || 0),
          failed: Number(m.pulses_failed || 0)
        };
      });
      
      // Pour l'instant on a que LOC
      const loc = stats.loc || { alive: false, pending: 0, failed: 0 };
      
      const totalModules = 1;
      const aliveModules = loc.alive ? 1 : 0;
      const totalPending = loc.pending;
      const totalFailed = loc.failed;
      
      // Calcul du score (0-100)
      let score = 0;
      if(totalModules > 0){
        score += (aliveModules / totalModules) * 50; // 50 points si worker alive
        score += Math.max(0, 30 - totalPending);     // -1 point par pulse pending
        score += Math.max(0, 20 - (totalFailed * 5)); // -5 points par failed
      }
      
      const globalScore = Math.round(Math.max(0, Math.min(100, score)));
      
      return {
        activity_7d: loc.alive ? "üü¢ LIVE" : "üî¥ OFF",
        alerts: totalFailed,
        pulse_pending: totalPending,
        pulse_failed: totalFailed,
        score: globalScore,
        due_payment: false
      };
      
    } catch(err) {
      console.error('ü¶Ö fetchKPIs error:', err);
      return {
        activity_7d: "‚ùå",
        alerts: 0,
        pulse_pending: 0,
        pulse_failed: 0,
        score: 0,
        due_payment: false
      };
    }
  }

  async function main(){
    // 0) Guard obligatoire
    setStatus("üîê Contr√¥le d'acc√®s‚Ä¶");
    if(!window.digiyGuard){
      setStatus("‚ùå guard.js introuvable");
      return;
    }

    const guardRes = await window.digiyGuard({
      allow_admin: true,
      redirect_to: "./login.html"
    });

    if(!guardRes || !guardRes.ok){
      return;
    }

    // 1) Contexte user
    const userId = guardRes.user_id;
    const profile = guardRes.profile || {};
    const role = (profile.role_auto || profile.role || (guardRes.admin ? "admin" : "pro"));

    // 2) slug
    const slug = getSlug();
    safeText("chipSlug", "slug: " + (slug || "‚Äî"));
    safeText("chipRole", "role: " + (role || "‚Äî"));
    safeText("chipUser", "user: " + (userId ? (String(userId).slice(0,8) + "‚Ä¶") : "‚Äî"));

    // 3) Liens safe
    $("hubLink").href   = withSlug("./", slug);
    $("pulseLink").href = withSlug("./pulse.html", slug);

    $("refreshBtn").addEventListener("click", (e)=>{
      e.preventDefault();
      location.reload();
    });

    $("logoutBtn").addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        const sb = window.__digiy_sb__ || window.supa;
        if(sb && sb.auth && sb.auth.signOut){
          await sb.auth.signOut();
        }
      }catch(_){}
      location.href = "./login.html";
    });

    // 4) Afficher doctrine Swarm
    const panel = $("swarmPanel");
    if(panel) panel.style.display = "block";

    // 5) Chargement KPIs R√âELS
    setStatus("üì° Chargement KPIs‚Ä¶");
    const sb = window.__digiy_sb__ || window.supa;
    if(!sb){
      setStatus("‚ùå Supabase client non initialis√©");
      return;
    }

    const ctx = { user_id:userId, profile, slug };
    const k = await fetchKPIs(sb, ctx);

    // 6) Render KPIs
    safeText("kpiActivity", k.activity_7d ?? "‚Äî");
    safeText("kpiAlerts",   (k.alerts ?? 0));
    safeText("kpiPulse", k.pulse_pending ?? 0);

    const score = clamp(Number(k.score ?? 0), 0, 100);
    safeText("kpiScore", score);

    // 7) Temp√©rature
    const t = scoreToTemp(score);
    safeText("tempTxt", t.label);
    safeText("subTemp", `${t.hint}${slug ? (" ‚Ä¢ " + slug) : ""}`);

    // 8) Due / urgence
    const due = !!(t.due || k.due_payment || (Number(k.alerts || 0) >= 3));
    setDue("cardScore","badgeScoreDue", due);
    setDue("cardAlerts","badgeAlertsDue", Number(k.alerts || 0) >= 1);
    setDue("cardPulse","badgePulseDue", Number(k.pulse_pending || 0) > 5);
    setDue("cardActivity","badgeActivityDue", k.activity_7d === "üî¥ OFF");

    if(k.activity_7d === "üî¥ OFF"){
      showUrgent("Worker DIGIY LOC offline. V√©rifie le serveur.", withSlug("./pulse.html", slug));
    } else if(Number(k.alerts || 0) >= 3){
      showUrgent("Plusieurs pulses ont √©chou√©. V√©rifie les logs.", withSlug("./pulse.html", slug));
    } else if(Number(k.pulse_pending || 0) > 10){
      showUrgent(`${k.pulse_pending} pulses en attente. Le worker rattrape.`, withSlug("./pulse.html", slug));
    }

    // 9) Status final
    setStatus(`‚úÖ OK ‚Ä¢ ${role}${guardRes.admin ? " (admin)" : ""}`);
  }

  main().catch((err)=>{
    try{ console.log("ü¶Ö Temperature error:", err); }catch(_){}
    setStatus("‚ùå Erreur");
    safeText("subTemp", "Une erreur est arriv√©e. Ouvre la console et on corrige.");
  });

})();
</script>

</body>
</html>
