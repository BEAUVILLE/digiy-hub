<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY RESTO ‚Äî Recherche</title>
  <meta name="theme-color" content="#0A0E1A" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg-dark:#020617;
      --bg-soft:#0B1120;
      --card:#0B1120;
      --card2:rgba(15,23,42,0.98);
      --cardBorder:rgba(148, 163, 184, 0.48);
      --ink:#F9FAFB;
      --ink-soft:#E5E7EB;
      --muted:#CBD5E1;
      --accent:#f97316;
      --accent-strong:#ea580c;
      --gold:#facc15;
      --success:#22c55e;
      --danger:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:'Manrope', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at top left, rgba(249,115,22,0.14), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,211,238,0.18), transparent 60%),
        #020617;
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:22px 16px 60px;
    }

    header{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:14px 16px;
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.55);
      background:linear-gradient(135deg, rgba(15,23,42,0.98), rgba(17,24,39,0.96));
      box-shadow:0 14px 40px rgba(0,0,0,0.75);
      margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      text-decoration:none;color:inherit;
    }
    .brand-logo{
      width:46px;height:46px;border-radius:16px;
      background:radial-gradient(circle at 30% 20%,#fef3c7,#f97316);
      display:flex;align-items:center;justify-content:center;
      font-size:1.8rem;font-weight:900;color:#111827;
      box-shadow:0 12px 32px rgba(249,115,22,0.55);
    }
    .brand-title{
      font-family:'Outfit',sans-serif;
      font-weight:950;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:1.2rem;
      background:linear-gradient(135deg,#f97316,#facc15,#22d3ee);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .brand-sub{
      font-size:.78rem;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .top-actions{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .btn{
      border-radius:999px;
      padding:.65rem 1.05rem;
      font-family:'Outfit',sans-serif;
      font-weight:950;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:.78rem;
      text-decoration:none;
      border:1px solid rgba(148,163,184,0.65);
      background:rgba(15,23,42,0.98);
      color:var(--ink);
      cursor:pointer;
      transition:transform .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(249,115,22,0.9);}
    .btn-primary{
      background:linear-gradient(135deg,#f97316,#ea580c);
      color:#111827;
      border:1px solid rgba(249,115,22,0.85);
      box-shadow:0 10px 28px rgba(249,115,22,0.35);
    }
    .btn-primary:hover{transform:translateY(-2px);}

    .card{
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.50);
      background:linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.95));
      box-shadow:0 16px 52px rgba(0,0,0,0.75);
      padding:16px;
      margin-bottom:14px;
    }

    .row{
      display:grid;
      grid-template-columns: 1.4fr .8fr auto;
      gap:10px;
      align-items:center;
    }
    @media(max-width:900px){
      .row{grid-template-columns:1fr; }
    }

    input, select{
      width:100%;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(2,6,23,0.55);
      color:var(--ink);
      outline:none;
      font-weight:650;
    }
    input::placeholder{color:rgba(203,213,225,0.75);}

    .filters{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:900px){
      .filters{grid-template-columns:1fr 1fr;}
    }

    .hint{
      margin-top:10px;
      font-size:.9rem;
      color:var(--muted);
      font-weight:650;
      line-height:1.5;
    }
    .hint strong{color:#fff;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.65);
      background:rgba(15,23,42,0.98);
      font-size:.78rem;
      color:var(--ink-soft);
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin-right:8px;
      margin-top:6px;
    }
    .pill-live{border-color:rgba(34,197,94,0.9); color:#dcfce7; background:rgba(22,163,74,0.14);}
    .pill-warn{border-color:rgba(250,204,21,0.95); color:#fef9c3; background:rgba(250,204,21,0.12);}

    .results-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin:10px 2px 0;
    }
    .results-title{
      font-family:'Outfit',sans-serif;
      font-weight:950;
      font-size:1.2rem;
      letter-spacing:.04em;
    }
    .small{
      font-size:.85rem;
      color:var(--muted);
      font-weight:650;
    }

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(260px,1fr));
      gap:12px;
    }

    .item{
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.50);
      background:
        radial-gradient(circle at top left,rgba(249,115,22,0.10),transparent 60%),
        rgba(11,17,32,0.98);
      padding:14px 14px 12px;
      transition:transform .16s ease, border-color .16s ease;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      min-height:140px;
    }
    .item:hover{
      transform:translateY(-3px);
      border-color:rgba(249,115,22,0.85);
    }
    .item-top{
      display:flex;justify-content:space-between;gap:8px;align-items:flex-start;
      margin-bottom:8px;
    }
    .name{
      font-family:'Outfit',sans-serif;
      font-weight:950;
      font-size:1.02rem;
      line-height:1.2;
    }
    .badge{
      font-size:.72rem;
      padding:5px 10px;
      border-radius:999px;
      font-weight:950;
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,0.65);
      color:var(--muted);
      background:rgba(15,23,42,0.98);
      white-space:nowrap;
    }
    .badge-premium{
      border-color:rgba(250,204,21,0.95);
      color:#111827;
      background:linear-gradient(135deg,#facc15,#fde68a);
    }

    .meta{
      display:flex;flex-wrap:wrap;gap:8px;
      font-size:.85rem;
      color:var(--ink-soft);
      font-weight:650;
      margin-bottom:8px;
    }
    .desc{
      font-size:.88rem;
      color:var(--muted);
      line-height:1.5;
      font-weight:650;
      min-height:40px;
    }
    .foot{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:10px;
      gap:8px;
    }
    .cta{
      border:none;
      border-radius:999px;
      padding:.6rem .95rem;
      background:linear-gradient(135deg,#f97316,#ea580c);
      color:#111827;
      font-family:'Outfit',sans-serif;
      font-weight:950;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:.75rem;
      cursor:pointer;
      white-space:nowrap;
    }
    .muted{
      color:var(--muted);
      font-size:.82rem;
      font-weight:650;
    }

    .empty{
      padding:16px;
      border-radius:18px;
      border:1px dashed rgba(148,163,184,0.55);
      color:var(--muted);
      font-weight:650;
      background:rgba(2,6,23,0.35);
      margin-top:12px;
    }

    .debug{
      margin-top:10px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.82rem;
      color:rgba(203,213,225,0.85);
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <a class="brand" href="./index.html">
        <div class="brand-logo">‚àû</div>
        <div>
          <div class="brand-title">DIGIY RESTO</div>
          <div class="brand-sub">RECHERCHE ‚Äî D√âCOUVRIR LES RESTOS</div>
        </div>
      </a>

      <div class="top-actions">
        <a class="btn" href="./index.html">‚Üê HUB</a>
        <a class="btn" href="https://digiylyfe.com/menus-pages">‚ò∞ MENU</a>
        <a class="btn btn-primary" href="https://beauville.github.io/mon-espace-digiy/">üîê SE CONNECTER</a>
      </div>
    </header>

    <div class="card">
      <!-- TEXTE EN PREMIER ‚úÖ -->
      <div class="row">
        <input id="q" placeholder='Ex: "fatou plateau dakar" (min 2 lettres)' />
        <input id="city" placeholder="Ville (optionnel) : Dakar" />
        <button class="cta" id="btn">Rechercher ‚Üí</button>
      </div>

      <div class="filters">
        <select id="minRating">
          <option value="">Note min (optionnel)</option>
          <option value="3.5">‚â• 3.5</option>
          <option value="4">‚â• 4.0</option>
          <option value="4.5">‚â• 4.5</option>
        </select>

        <select id="maxPrice">
          <option value="">Budget max (optionnel)</option>
          <option value="1">‚Ç¨ (1)</option>
          <option value="2">‚Ç¨‚Ç¨ (2)</option>
          <option value="3">‚Ç¨‚Ç¨‚Ç¨ (3)</option>
          <option value="4">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (4)</option>
        </select>

        <select id="sortBy">
          <option value="ranking">Tri : pertinence</option>
          <option value="rating">Tri : note</option>
          <option value="price">Tri : prix</option>
          <option value="new">Tri : r√©cent</option>
        </select>

        <select id="pack">
          <option value="">Pack (optionnel)</option>
          <option value="premium">premium</option>
          <option value="standard">standard</option>
          <option value="basic">basic</option>
        </select>
      </div>

      <div class="hint" id="status">
        Tape un mot-cl√© et lance la recherche. <strong>Objectif : discovery</strong> (trouver les fiches PRO).
        <div>
          <span class="pill pill-live">LIVE</span>
          <span class="pill pill-warn">RESTO</span>
        </div>
      </div>

      <div class="debug" id="debug"></div>
    </div>

    <div class="results-head">
      <div>
        <div class="results-title">R√©sultats</div>
        <div class="small" id="count">0 r√©sultat</div>
      </div>
      <div class="small" id="dataset">Dataset: ‚Äî</div>
    </div>

    <div id="results" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">Aucun r√©sultat. Essaie : <strong>‚Äúfatou dakar‚Äù</strong> ou enl√®ve les filtres.</div>

  </div>

  <script>
    /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â (TU AS DONN√â CES VALEURS) */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_ANON_KEY_IF_NEEDED";

    // Si tu veux, colle ici exactement ta ANON KEY (tu l'as d√©j√† dans ton code HUB)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI
    const elQ = document.getElementById("q");
    const elCity = document.getElementById("city");
    const elBtn = document.getElementById("btn");
    const elStatus = document.getElementById("status");
    const elDebug = document.getElementById("debug");
    const elResults = document.getElementById("results");
    const elEmpty = document.getElementById("empty");
    const elCount = document.getElementById("count");
    const elDataset = document.getElementById("dataset");

    const elMinRating = document.getElementById("minRating");
    const elMaxPrice = document.getElementById("maxPrice");
    const elSortBy = document.getElementById("sortBy");
    const elPack = document.getElementById("pack");

    function safeText(v){
      if(v === null || v === undefined) return "";
      return String(v);
    }

    function pick(obj, keys){
      for(const k of keys){
        if(obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
      }
      return null;
    }

    function normalizePack(v){
      if(!v) return null;
      return String(v).toLowerCase();
    }

    function render(rows){
      elResults.innerHTML = "";
      elEmpty.style.display = rows.length ? "none" : "block";
      elCount.textContent = rows.length + (rows.length > 1 ? " r√©sultats" : " r√©sultat");

      rows.forEach(r => {
        const name = pick(r, ["business_name","name","title","nom","nom_entreprise"]) || "Sans nom";
        const city = pick(r, ["city","ville"]) || "";
        const category = pick(r, ["category","categorie","cuisine"]) || "";
        const rating = pick(r, ["rating","note"]) || "";
        const price = pick(r, ["price_range","price","budget","price_level"]) || "";
        const pack = normalizePack(pick(r, ["subscription_pack","pack","plan","subscription","tier"])) || "";
        const desc = pick(r, ["description","about","bio","resume"]) || "";

        const badge = pack === "premium" ? "badge badge-premium" : "badge";
        const badgeText = pack ? pack : "resto";

        const card = document.createElement("div");
        card.className = "item";
        card.innerHTML = `
          <div class="item-top">
            <div class="name">${escapeHtml(name)}</div>
            <div class="${badge}">${escapeHtml(badgeText)}</div>
          </div>
          <div class="meta">
            ${city ? `<span>üìç ${escapeHtml(city)}</span>` : ""}
            ${category ? `<span>üçΩÔ∏è ${escapeHtml(category)}</span>` : ""}
            ${rating !== "" ? `<span>‚≠ê ${escapeHtml(rating)}</span>` : ""}
            ${price !== "" ? `<span>üí∞ ${escapeHtml(price)}</span>` : ""}
          </div>
          <div class="desc">${escapeHtml(desc).slice(0, 140)}${safeText(desc).length > 140 ? "‚Ä¶" : ""}</div>
          <div class="foot">
            <button class="cta">Voir ‚Üí</button>
            <div class="muted">Fiche</div>
          </div>
        `;

        // Clique ‚Üí plus tard tu mettras la page d√©tail /pro/:id
        card.addEventListener("click", () => {
          const id = pick(r, ["id","pro_id","uuid"]);
          if(id){
            alert("Page d√©tail √† brancher: pro_id = " + id);
          } else {
            alert("OK. Page d√©tail √† brancher (id manquant dans la ligne).");
          }
        });

        elResults.appendChild(card);
      });
    }

    function escapeHtml(str){
      return safeText(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function tryQuery(tableName){
      const q = safeText(elQ.value).trim();
      const city = safeText(elCity.value).trim();

      const minRating = elMinRating.value ? parseFloat(elMinRating.value) : null;
      const maxPrice = elMaxPrice.value ? parseFloat(elMaxPrice.value) : null;
      const sortBy = elSortBy.value || "ranking";
      const pack = normalizePack(elPack.value);

      // Base query
      let query = supabase.from(tableName).select("*").limit(40);

      // On force RESTO si la table a une colonne de type
      // (selon ton sch√©ma √ßa peut √™tre: listing_type / type / module / kind)
      // -> on applique plus bas via "or" textSearch-like (fallback)
      // Ici on fait simple: si colonne "listing_type" existe: on tente eq('listing_type','resto')
      // Si √ßa √©choue, la requ√™te renverra une erreur => on catch et on passe au prochain dataset.

      // Filtres city (si colonne existe)
      if(city){
        // on essaye city/ville, si √ßa casse => dataset suivant
        query = query.or(`city.ilike.%${city}%,ville.ilike.%${city}%`);
      }

      // Texte: on fait un OR sur plusieurs champs typiques (sans d√©pendre du SQL)
      if(q.length >= 2){
        const qq = q.replaceAll(",", " ").split(/\s+/).filter(Boolean).slice(0, 6);
        // on construit une recherche "ilike" multi-mots
        // => AND approximatif en r√©p√©tant des OR
        qq.forEach(word => {
          const w = word.replaceAll("%","").replaceAll("_","");
          query = query.or(
            [
              `business_name.ilike.%${w}%`,
              `name.ilike.%${w}%`,
              `title.ilike.%${w}%`,
              `city.ilike.%${w}%`,
              `ville.ilike.%${w}%`,
              `category.ilike.%${w}%`,
              `categorie.ilike.%${w}%`,
              `description.ilike.%${w}%`,
              `about.ilike.%${w}%`,
              `tags.cs.{${w}}`,
              `modules.cs.{${w}}`
            ].join(",")
          );
        });
      }

      // Rating
      if(minRating !== null){
        query = query.or(`rating.gte.${minRating},note.gte.${minRating}`);
      }

      // Price range max
      if(maxPrice !== null){
        query = query.or(`price_range.lte.${maxPrice},price_level.lte.${maxPrice},budget.lte.${maxPrice}`);
      }

      // Pack
      if(pack){
        query = query.or(
          `subscription_pack.eq.${pack},pack.eq.${pack},tier.eq.${pack},plan.eq.${pack},subscription.eq.${pack}`
        );
      }

      // Tri
      if(sortBy === "rating"){
        query = query.order("rating", { ascending:false, nullsFirst:false });
      } else if(sortBy === "price"){
        // prix croissant
        query = query.order("price_range", { ascending:true, nullsFirst:false });
      } else if(sortBy === "new"){
        query = query.order("created_at", { ascending:false, nullsFirst:false });
      } else {
        // pertinence
        query = query.order("ranking_score", { ascending:false, nullsFirst:false });
      }

      // RESTO constraint (tentative multi-colonnes)
      query = query.or("listing_type.eq.resto,type.eq.resto,module.eq.resto,kind.eq.resto");

      const { data, error } = await query;
      if(error) throw error;
      return data || [];
    }

    async function runSearch(){
      const q = safeText(elQ.value).trim();
      if(q.length && q.length < 2){
        elStatus.innerHTML = `‚õî Tape au moins <strong>2 lettres</strong>.`;
        return;
      }

      elStatus.innerHTML = `‚è≥ Recherche en cours...`;
      elDebug.textContent = "";

      const datasetsToTry = [
        "public_listings",
        "listings",
        "pros"
      ];

      let lastErr = null;

      for(const ds of datasetsToTry){
        try{
          const rows = await tryQuery(ds);
          elDataset.textContent = "Dataset: " + ds;
          elStatus.innerHTML = `‚úÖ OK ‚Äî ${rows.length} r√©sultat(s).`;
          render(rows);
          return;
        }catch(err){
          lastErr = err;
          // on tente le prochain dataset
          console.warn("Dataset failed:", ds, err);
        }
      }

      // Si tout √©choue
      elDataset.textContent = "Dataset: aucun";
      elStatus.innerHTML = `‚ùå Impossible de lire les donn√©es (RLS / table / colonnes).`;
      elResults.innerHTML = "";
      elEmpty.style.display = "block";
      elCount.textContent = "0 r√©sultat";

      // Debug visible (tu vas comprendre DIRECT)
      elDebug.textContent =
        "DEBUG (√† copier-coller ici si √ßa bloque) :\n" +
        (lastErr ? JSON.stringify(lastErr, null, 2) : "Erreur inconnue");
    }

    // Debounce tape
    let t = null;
    function debounceSearch(){
      clearTimeout(t);
      t = setTimeout(runSearch, 380);
    }

    elBtn.addEventListener("click", runSearch);
    elQ.addEventListener("input", debounceSearch);
    elCity.addEventListener("input", debounceSearch);
    [elMinRating, elMaxPrice, elSortBy, elPack].forEach(el => el.addEventListener("change", runSearch));

    // Enter = recherche
    elQ.addEventListener("keydown", (e) => {
      if(e.key === "Enter") runSearch();
    });
    elCity.addEventListener("keydown", (e) => {
      if(e.key === "Enter") runSearch();
    });

    // Auto-focus
    elQ.focus();

    // Petite recherche √† vide (√ßa ne fait rien si q est vide)
    // runSearch();
  </script>

</body>
</html>
