<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY RESTO ‚Äî Recherche</title>
  <meta name="theme-color" content="#0A0E1A" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;700;800;900&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617;
      --card:rgba(15,23,42,0.92);
      --border:rgba(148,163,184,0.48);
      --ink:#F9FAFB;
      --muted:#CBD5E1;
      --gold:#facc15;
      --accent:#f97316;
      --accent2:#22d3ee;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Manrope',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at top left, rgba(249,115,22,0.14), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,211,238,0.16), transparent 60%),
        var(--bg);
      color:var(--ink);
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:1.2rem}
    header{
      display:flex;justify-content:space-between;align-items:center;gap:1rem;
      padding:1rem 1.2rem;border-radius:22px;
      background:linear-gradient(135deg, rgba(15,23,42,0.98), rgba(17,24,39,0.96));
      border:1px solid var(--border);
      box-shadow:0 14px 40px rgba(0,0,0,0.65);
      margin-bottom:1.2rem;
    }
    .brand{display:flex;align-items:center;gap:.9rem;text-decoration:none;color:inherit}
    .logo{
      width:52px;height:52px;border-radius:16px;
      background:radial-gradient(circle at 30% 20%,#fef3c7,#f97316);
      display:flex;align-items:center;justify-content:center;
      font-size:1.9rem;font-weight:900;color:#111827;
      box-shadow:0 12px 32px rgba(249,115,22,0.6);
    }
    .title{
      font-family:'Outfit',sans-serif;
      font-weight:900;letter-spacing:.08em;text-transform:uppercase;
      font-size:1.15rem;
      background:linear-gradient(135deg,#f97316,#facc15,#22d3ee);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .subtitle{color:var(--muted);font-weight:800;font-size:.82rem;letter-spacing:.14em;text-transform:uppercase}

    .top-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:none;cursor:pointer;text-decoration:none;
      padding:.7rem 1.05rem;border-radius:999px;
      font-family:'Outfit',sans-serif;font-weight:950;
      letter-spacing:.10em;text-transform:uppercase;font-size:.78rem;
      display:inline-flex;align-items:center;gap:.5rem;
      white-space:nowrap;
    }
    .btn-gold{
      color:#111827;background:linear-gradient(135deg,#facc15,#fde68a);
      border:1px solid rgba(250,204,21,.9);
      box-shadow:0 10px 28px rgba(250,204,21,0.22);
    }
    .btn-dark{
      color:var(--ink);background:rgba(15,23,42,0.98);
      border:1px solid var(--border);
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:24px;
      padding:1.1rem;
      box-shadow:0 16px 52px rgba(0,0,0,0.75);
      margin-bottom:1rem;
    }
    .h1{
      font-family:'Outfit',sans-serif;
      font-size:1.6rem;
      font-weight:950;
      margin-bottom:.25rem;
    }
    .p{color:var(--muted);font-weight:650;line-height:1.6;margin-bottom:1rem}
    .row{
      display:grid;
      grid-template-columns: 1.7fr 1fr auto;
      gap:.7rem;
      align-items:center;
    }
    @media(max-width:820px){
      .row{grid-template-columns: 1fr; }
    }
    input{
      width:100%;
      padding:.95rem 1rem;
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(2,6,23,0.55);
      color:var(--ink);
      outline:none;
      font-weight:750;
    }
    input::placeholder{color:rgba(203,213,225,0.7);font-weight:650}
    .cta{
      padding:.95rem 1.1rem;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-family:'Outfit',sans-serif;
      font-weight:950;
      letter-spacing:.06em;
      background:linear-gradient(135deg,var(--accent),#ea580c);
      color:#111827;
      box-shadow:0 12px 32px rgba(249,115,22,0.5);
      white-space:nowrap;
    }
    .hint{
      margin-top:.75rem;
      font-size:.92rem;
      color:var(--muted);
      font-weight:700;
      display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(203,213,225,0.45)}
    .dot.ok{background:rgba(34,197,94,0.9)}
    .dot.bad{background:rgba(239,68,68,0.9)}
    .dot.busy{background:rgba(250,204,21,0.95)}

    .results{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:.9rem;
      margin-top:.9rem;
    }
    .item{
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.50);
      background:
        radial-gradient(circle at top left, rgba(249,115,22,0.12), transparent 60%),
        rgba(11,17,32,0.96);
      padding:1rem;
      cursor:pointer;
      transition:transform .15s ease, border-color .15s ease, box-shadow .15s ease;
      position:relative;
      overflow:hidden;
    }
    .item:hover{
      transform:translateY(-3px);
      border-color:rgba(249,115,22,0.9);
      box-shadow:0 18px 42px rgba(0,0,0,0.75);
    }
    .item-title{
      font-family:'Outfit',sans-serif;
      font-weight:950;
      font-size:1.06rem;
      margin-bottom:.25rem;
    }
    .item-meta{color:var(--muted);font-weight:750;font-size:.9rem;line-height:1.45}
    .badge{
      position:absolute;top:.85rem;right:.85rem;
      font-size:.72rem;
      padding:.28rem .7rem;
      border-radius:999px;
      border:1px solid rgba(250,204,21,0.9);
      background:rgba(250,204,21,0.14);
      color:#fef9c3;
      font-weight:950;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .small{font-size:.82rem;color:var(--muted);font-weight:700;margin-top:.5rem}
    .empty{
      padding:1rem;
      border-radius:18px;
      border:1px dashed rgba(148,163,184,0.55);
      color:var(--muted);
      font-weight:750;
      margin-top:.9rem;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <a class="brand" href="index.html" title="Retour DIGIY HUB">
        <div class="logo">‚àû</div>
        <div>
          <div class="title">DIGIY RESTO</div>
          <div class="subtitle">Recherche ‚Ä¢ D√©couverte ‚Ä¢ 0% commission</div>
        </div>
      </a>

      <div class="top-actions">
        <a class="btn btn-dark" href="index.html">‚Üê HUB</a>
        <a class="btn btn-gold" href="https://digiylyfe.com/menus-pages" target="_blank" rel="noopener">‚ò∞ Menu</a>
      </div>
    </header>

    <section class="card">
      <div class="h1">Trouver un restaurant</div>
      <div class="p">Tape d‚Äôabord le <strong>nom</strong>, le <strong>quartier</strong> ou un mot-cl√© (ex: ‚Äúfatou plateau dakar‚Äù). Ensuite, ville si tu veux.</div>

      <div class="row">
        <!-- ‚úÖ TEXTE EN PREMIER -->
        <input id="q" placeholder='Ex: "fatou plateau dakar" (min 2 lettres)' autocomplete="off" />
        <input id="city" placeholder="Ville (optionnel) : Dakar" autocomplete="off" />
        <button class="cta" id="btn">Rechercher ‚Üí</button>
      </div>

      <div class="hint" id="status">
        <span class="dot" id="dot"></span>
        <span id="statusText">Tape et lance la recherche.</span>
      </div>

      <div id="out"></div>
    </section>

    <div class="small">Astuce : si tu veux plus tard, on ajoute ‚Äúautour de moi‚Äù (g√©oloc + rayon) avec PostGIS.</div>
  </div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â (tu peux garder exactement tes valeurs) */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $q = document.getElementById("q");
    const $city = document.getElementById("city");
    const $btn = document.getElementById("btn");
    const $out = document.getElementById("out");

    const $dot = document.getElementById("dot");
    const $statusText = document.getElementById("statusText");

    function setStatus(state, text){
      $statusText.textContent = text || "";
      $dot.className = "dot";
      if(state === "ok") $dot.classList.add("ok");
      if(state === "bad") $dot.classList.add("bad");
      if(state === "busy") $dot.classList.add("busy");
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function renderResults(rows){
      if(!rows || rows.length === 0){
        $out.innerHTML = `<div class="empty">Aucun resto trouv√©. Essaie un autre mot (ex: ‚Äúdakar‚Äù, ‚Äúplateau‚Äù, ‚Äúfatou‚Äù).</div>`;
        return;
      }

      const cards = rows.map(r => {
        const name = r.business_name || r.display_name || "Restaurant";
        const city = r.city || "";
        const country = r.country || "SN";
        const phone = r.phone || "";
        const email = r.email || "";
        const modules = Array.isArray(r.modules) ? r.modules : [];
        const activeMods = Array.isArray(r.active_modules) ? r.active_modules : [];
        const isPremium = (String(r.payment_status || "").toLowerCase() === "premium") ||
                          (activeMods.includes("premium")) || (modules.includes("premium"));

        return `
          <div class="item" data-id="${esc(r.id)}">
            ${isPremium ? `<div class="badge">Premium</div>` : ``}
            <div class="item-title">${esc(name)}</div>
            <div class="item-meta">
              üìç ${esc(city)} ‚Ä¢ ${esc(country)}<br>
              ${phone ? `üìû ${esc(phone)}<br>` : ``}
              ${email ? `‚úâÔ∏è ${esc(email)}<br>` : ``}
              <span style="opacity:.85">ID: ${esc(String(r.id).slice(0,8))}</span>
            </div>
          </div>
        `;
      }).join("");

      $out.innerHTML = `<div class="results">${cards}</div>`;

      // clic (plus tard: ouvrir page d√©tail / fiche)
      $out.querySelectorAll(".item").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          alert("Fiche RESTO (√† brancher) ‚Äî PRO ID: " + id);
          // Exemple futur:
          // window.location.href = "resto-details.html?id=" + encodeURIComponent(id);
        });
      });
    }

    async function runSearch(){
      const q = ($q.value || "").trim();
      const city = ($city.value || "").trim();

      if(q.length < 2 && city.length < 2){
        setStatus("", "Tape au moins 2 lettres (ou une ville).");
        $out.innerHTML = "";
        return;
      }

      setStatus("busy", "Recherche en cours‚Ä¶");
      $out.innerHTML = "";

      try{
        // Base query: table pros
        let query = supabase
          .from("pros")
          .select("id,business_name,display_name,city,country,phone,email,modules,active_modules,is_active,created_at,payment_status,status")
          .eq("is_active", true);

        // ‚úÖ RESTO = modules OU active_modules contient "resto"
        // PostgREST: operator cs works with array/jsonb -> {resto}
        query = query.or("modules.cs.{resto},active_modules.cs.{resto}");

        // Ville optionnel
        if(city.length >= 2){
          query = query.ilike("city", `%${city}%`);
        }

        // Texte : on cherche dans business_name, display_name, city (simple mais efficace)
        if(q.length >= 2){
          const safe = q.replace(/[,]/g, " ").trim();
          // OR sur 3 champs (PostgREST)
          query = query.or(
            `business_name.ilike.%${safe}%,display_name.ilike.%${safe}%,city.ilike.%${safe}%`
          );
        }

        // Tri: r√©cent d'abord (on am√©liorera par ranking plus tard)
        query = query.order("created_at", { ascending: false }).limit(30);

        const { data, error } = await query;

        if(error){
          console.error(error);
          setStatus("bad", "Erreur Supabase: " + (error.message || "inconnue"));
          $out.innerHTML = `<div class="empty">Erreur: ${esc(error.message || "inconnue")}</div>`;
          return;
        }

        setStatus("ok", `${data.length} r√©sultat(s)`);
        renderResults(data);

      }catch(err){
        console.error(err);
        setStatus("bad", "Crash JS: " + (err.message || err));
        $out.innerHTML = `<div class="empty">Crash JS: ${esc(err.message || err)}</div>`;
      }
    }

    // bouton
    $btn.addEventListener("click", runSearch);

    // Enter
    [$q, $city].forEach(inp => {
      inp.addEventListener("keydown", (e) => {
        if(e.key === "Enter") runSearch();
      });
    });

    // Debounce (tape ‚Üí recherche douce)
    let t = null;
    $q.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(runSearch, 450);
    });

    // focus direct sur le texte
    setTimeout(() => $q.focus(), 150);
  </script>
</body>
</html>
