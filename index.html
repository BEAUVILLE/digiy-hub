<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#020617">
<title>digiy hub ‚àû ‚Äî 0% commission ‚Ä¢ paiement direct</title>
<meta name="description" content="Tous tes modules business DIGIY : chauffeur, resto, location, artisan. 0% commission. Paiement direct au pro.">

<style>
:root{--bg:#020617;--card:#0B1120;--border:rgba(148,163,184,.38);--ink:#F9FAFB;--muted:#CBD5E1;--orange:#f97316;--orange-dark:#ea580c;--gold:#facc15;--cyan:#22d3ee;--green:#22c55e;--green-dark:#16a34a;--red:#ef4444;--shadow:0 18px 60px rgba(0,0,0,.55)}
*{box-sizing:border-box}
body{margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#000}
a{color:inherit;text-decoration:none}
button{font-family:inherit}
.app{width:100%;max-width:1400px;margin:0 auto;padding:18px;border:1px solid rgba(148,163,184,.22);border-radius:22px;background:radial-gradient(circle at 15% 10%,rgba(249,115,22,.10),transparent 55%),radial-gradient(circle at 85% 90%,rgba(34,211,238,.12),transparent 60%),rgba(2,6,23,.86);box-shadow:var(--shadow)}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-radius:18px;background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(17,24,39,.96));border:1px solid var(--border);box-shadow:0 12px 36px rgba(0,0,0,.35)}
.brand{display:flex;align-items:center;gap:12px}
.brand-logo{width:50px;height:50px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:950;font-size:26px;color:#111827;background:radial-gradient(circle at 30% 20%,#fef3c7,#f97316);box-shadow:0 12px 26px rgba(249,115,22,.45)}
.brand h1{margin:0;font-size:20px;letter-spacing:.08em;text-transform:uppercase}
.brand p{margin:0;font-size:12px;color:var(--muted);font-weight:750;letter-spacing:.12em;text-transform:uppercase}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:rgba(15,23,42,.92);color:var(--ink);font-weight:900;cursor:pointer}
.btn:hover{border-color:rgba(249,115,22,.9);background:rgba(249,115,22,.10)}
.hero{margin-top:14px;padding:24px 18px;border-radius:20px;border:1px solid rgba(148,163,184,.22);background:radial-gradient(circle at top right,rgba(251,191,36,.10),transparent 60%),linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.94));text-align:center;box-shadow:0 14px 40px rgba(0,0,0,.35)}
.hero-eyebrow{color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.14em;font-size:12px;margin-bottom:10px}
.hero-title{font-weight:950;font-size:32px;line-height:1.1;margin:0 0 10px}
.hero-title span{background:linear-gradient(135deg,#f97316,#facc15,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-subtitle{color:#E5E7EB;font-weight:650;line-height:1.55;margin:0 auto 16px;max-width:820px}
.hero-cta{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 18px;border-radius:999px;border:none;font-weight:950;cursor:pointer;background:linear-gradient(135deg,var(--orange),var(--orange-dark));color:#111827;box-shadow:0 12px 34px rgba(249,115,22,.40);margin:6px}
.hero-cta.secondary{background:linear-gradient(135deg,#22d3ee,#60a5fa);box-shadow:0 12px 34px rgba(34,211,238,.25)}
.urgency-strip{display:inline-flex;align-items:center;gap:8px;margin-top:14px;padding:8px 12px;border-radius:999px;border:1px solid rgba(250,204,21,.85);background:linear-gradient(90deg,rgba(249,115,22,.18),rgba(250,204,21,.12));font-weight:800;font-size:13px}
.urgency-number{color:var(--red);font-weight:950}
.section{margin-top:16px;padding:18px;border-radius:20px;border:1px solid rgba(148,163,184,.22);background:linear-gradient(145deg,rgba(15,23,42,.96),rgba(15,23,42,.92))}
.section h2{margin:0 0 6px;font-size:18px;font-weight:950;text-transform:lowercase}
.section p{margin:0 0 14px;color:var(--muted);font-weight:650}
.modules-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px}
.module{border:1px solid rgba(148,163,184,.25);border-radius:18px;padding:14px;background:radial-gradient(circle at top left,rgba(249,115,22,.12),transparent 60%),rgba(11,17,32,.98);transition:transform .15s,border-color .15s,box-shadow .15s;cursor:pointer}
.module:hover{transform:translateY(-3px);border-color:rgba(249,115,22,.8);box-shadow:0 16px 40px rgba(0,0,0,.45)}
.module-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px}
.module-icon{width:42px;height:42px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.95);border:1px solid rgba(148,163,184,.25);font-size:18px}
.module-name{font-weight:950;text-transform:lowercase}
.module-tag{font-size:11px;color:var(--muted);font-weight:850;letter-spacing:.12em;text-transform:uppercase}
.badge{font-size:11px;font-weight:950;letter-spacing:.12em;text-transform:uppercase;padding:6px 10px;border-radius:999px;border:1px solid rgba(34,197,94,1);background:rgba(22,163,74,.14);color:#dcfce7;white-space:nowrap}
.badge.new{border-color:rgba(249,115,22,1);background:rgba(249,115,22,.14);color:#fed7aa}
.badge.prio{border-color:rgba(250,204,21,1);background:rgba(250,204,21,.12);color:#fef9c3}
.badge.free{border-color:rgba(34,211,238,1);background:rgba(34,211,238,.10);color:#cffafe}
.module-body{color:#E5E7EB;font-weight:650;line-height:1.5;font-size:13px}
footer{margin-top:16px;padding-top:14px;border-top:1px solid rgba(148,163,184,.22);color:var(--muted);font-weight:650;text-align:center;font-size:13px}

/* floating buttons */
#tarif-bubble-btn{position:fixed;right:18px;bottom:154px;z-index:2147483645;display:flex;align-items:center;gap:8px;padding:10px 12px;border:none;border-radius:999px;font-weight:950;font-size:12px;color:#111827;cursor:pointer;background:linear-gradient(135deg,var(--orange),var(--orange-dark));box-shadow:0 14px 36px rgba(249,115,22,.35)}
#espace-pro-btn{position:fixed;right:18px;bottom:86px;z-index:2147483645;display:flex;align-items:center;gap:8px;padding:10px 12px;border:none;border-radius:999px;font-weight:950;font-size:12px;color:#052e16;cursor:pointer;background:linear-gradient(135deg,var(--green),var(--green-dark));box-shadow:0 14px 36px rgba(34,197,94,.35)}
#digiy-help-btn{position:fixed;right:18px;bottom:18px;z-index:2147483646;border:none;border-radius:999px;padding:12px 14px;font-weight:950;font-size:14px;color:#052e16;cursor:pointer;background:linear-gradient(135deg,var(--green-dark),var(--green));box-shadow:0 16px 40px rgba(0,0,0,.25)}

/* overlays */
#hubOverlay,#digiy-ndimbal,#qrModal{display:none;position:fixed;inset:0;backdrop-filter:blur(8px);pointer-events:none}
#hubOverlay.show,#digiy-ndimbal.show,#qrModal.show{display:block;pointer-events:auto}
#hubOverlay{z-index:2147483647;background:rgba(0,0,0,.72);padding:12px}
#digiy-ndimbal{z-index:2147483646;background:rgba(0,0,0,.68);padding:16px}
#qrModal{z-index:2147483647;background:rgba(0,0,0,.75);padding:16px}

/* hub */
.hubCard{height:calc(100vh - 24px);max-width:1400px;margin:0 auto;border-radius:18px;border:1px solid rgba(148,163,184,.30);background:rgba(2,6,23,.86);overflow:hidden;display:flex;flex-direction:column;box-shadow:0 18px 70px rgba(0,0,0,.55)}
.hubTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(17,24,39,.96));border-bottom:1px solid rgba(148,163,184,.22)}
.hubBrand{font-weight:950;letter-spacing:.08em;text-transform:uppercase}
.hubTopBtns{display:flex;gap:10px}
.hubBtn{border:none;border-radius:999px;padding:10px 12px;font-weight:950;cursor:pointer}
.hubBtn.back{background:linear-gradient(135deg,var(--gold),#fde68a);color:#111827}
.hubBtn.close{background:rgba(15,23,42,.98);color:#e5e7eb;border:1px solid rgba(148,163,184,.30)}
#hubFrame{width:100%;height:100%;border:0;background:#fff}

/* ndimbal card */
.digiyBox{max-width:400px;margin:14vh auto 0;background:#fff;border-radius:18px;padding:16px;box-shadow:0 20px 55px rgba(0,0,0,.35);text-align:center}
.digiyTitle{font-weight:950;color:var(--green-dark);font-size:18px;margin-bottom:6px}
.digiyText{color:#0f172a;font-weight:650;line-height:1.45;margin:10px 0 14px}
.digiyAct{width:100%;border:none;border-radius:14px;padding:12px 14px;margin:7px 0;font-weight:900;cursor:pointer;background:#f1f5f9;color:#0f172a}
.digiyClose{width:100%;border:none;border-radius:14px;padding:11px 14px;margin-top:10px;font-weight:950;cursor:pointer;background:#0f172a;color:#fff}

/* qr */
.qrContent{max-width:420px;margin:10vh auto;background:#fff;border-radius:20px;padding:20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.50)}
.qrHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.qrTitle{font-weight:950;letter-spacing:.06em;text-transform:uppercase;color:#0f172a;font-size:1.05rem}
.qrImg{width:260px;height:260px;border-radius:16px;border:2px solid #16a34a;padding:12px;background:#fff;margin:0 auto 12px}
.qrLink{display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;max-width:320px;background:linear-gradient(135deg,#16a34a,#22c55e);color:#052e16;padding:12px 18px;border-radius:14px;font-weight:950;text-decoration:none}

/* badge paiement manuel */
.payPill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid rgba(148,163,184,.30);background:rgba(2,6,23,.55);font-size:11px;font-weight:950;letter-spacing:.12em;text-transform:uppercase;white-space:nowrap}
.payDot{width:9px;height:9px;border-radius:999px;background:rgba(250,204,21,1)}
.payDot.green{background:rgba(34,197,94,1)}
.payDot.red{background:rgba(239,68,68,1)}

@media(max-width:820px){
  .hero-title{font-size:24px}
  .app{padding:12px}
  #tarif-bubble-btn{right:14px;bottom:152px}
  #espace-pro-btn{right:14px;bottom:84px}
  #digiy-help-btn{right:14px;bottom:14px}
}
</style>
</head>

<body>

<div class="app">
<header>
  <a href="#" class="brand" id="homeBrand">
    <div class="brand-logo">‚àû</div>
    <div>
      <h1>digiy hub</h1>
      <p>0% commission ‚Ä¢ paiement direct</p>
    </div>
  </a>
  <button class="btn" type="button" id="btnLogin">üîê connexion</button>
</header>

<section class="hero">
  <div class="hero-eyebrow">l'afrique enracin√©e, connect√©e au monde</div>
  <h1 class="hero-title">Tout ton business dans ta main.<br><span>0% commission.</span></h1>
  <p class="hero-subtitle">
    Chauffeur, restaurant, boutique, logement, artisan.<br>
    <strong>Un seul abonnement. 11 m√©tiers. Paiement direct au pro.</strong>
  </p>
  <button id="btnGetHub" class="hero-cta" type="button"><span>‚Üí</span> je veux mon hub digiy</button>
  <button id="btnDeals" class="hero-cta secondary" type="button">üí• voir les bonnes affaires</button>
  <div style="margin-top:10px;color:var(--muted);font-weight:650">Places pionniers limit√©es ‚Ä¢ Prix bloqu√© √† vie pour les premiers</div>
  <div class="urgency-strip">
    <span>üî•</span><span>Places restantes :</span>
    <span id="pioneersLeft" class="urgency-number">87</span>
  </div>
</section>

<section class="section">
  <h2>tous tes modules digiy</h2>
  <p>Tu ajoutes/retire un module en modifiant <strong>MODULES[]</strong> dans le script.</p>

  <div class="modules-grid" id="modulesGrid"></div>
</section>

<footer>
  <div style="font-weight:950;color:#fff;margin-bottom:6px">L'Afrique enracin√©e, connect√©e au monde ‚Äî digiylyfe ‚ôæÔ∏è</div>
  <div style="display:flex;justify-content:center;gap:14px;flex-wrap:wrap;margin-bottom:8px">
    <a href="https://digiylyfe.com" target="_blank" rel="noopener">Accueil digiylyfe</a>
    <a href="https://wa.me/221771342889" target="_blank" rel="noopener">Contact WhatsApp</a>
    <a href="https://beauville.github.io/DIGIY/" target="_blank" rel="noopener">Tarifs d√©taill√©s</a>
  </div>
  <div>¬© digiylyfe ‚Äî Made in S√©n√©gal ‚Ä¢ 0% commission ‚Ä¢ paiement direct</div>
</footer>
</div>

<button id="tarif-bubble-btn" type="button">üè∑Ô∏è tarifs digiy</button>
<button id="espace-pro-btn" type="button">üß∞ espace pro</button>
<button id="digiy-help-btn" type="button">‚ôæÔ∏è ndimbal</button>

<!-- ndimbal overlay -->
<div id="digiy-ndimbal" aria-hidden="true">
  <div class="digiyBox">
    <div class="digiyTitle">‚ôæÔ∏è ndimbal</div>
    <div class="digiyText"><strong>Naka nga def fr√©rot ?</strong><br>Je suis l√† pour t'aider simplement.</div>
    <button class="digiyAct" type="button" data-action="sell">üìã publier une mission</button>
    <button class="digiyAct" type="button" data-action="job">üíº trouver du travail</button>
    <button class="digiyAct" type="button" data-action="qr">üì∑ ouvrir qr digiylyfe</button>
    <button class="digiyClose" type="button" id="digiyCloseBtn">‚ùå quitter</button>
  </div>
</div>

<!-- qr overlay -->
<div id="qrModal" aria-hidden="true">
  <div class="qrContent">
    <div class="qrHeader">
      <div class="qrTitle">‚ôæÔ∏è qr digiylyfe</div>
      <button id="qrClose" style="border:none;background:#f1f5f9;color:#0f172a;padding:8px 12px;border-radius:12px;font-weight:900;cursor:pointer;font-size:.85rem" type="button">‚úñ fermer</button>
    </div>
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://digiylyfe.com" alt="QR DIGIYLYFE" class="qrImg" loading="lazy">
    <div style="color:#0f172a;font-weight:800;margin-bottom:12px;font-size:1rem">üì± scanne pour ouvrir digiylyfe</div>
    <a href="https://digiylyfe.com" target="_blank" rel="noopener" class="qrLink">ouvrir le site ‚Üí</a>
  </div>
</div>

<!-- hub overlay -->
<div id="hubOverlay" aria-hidden="true">
  <div class="hubCard" role="dialog" aria-modal="true">
    <div class="hubTop">
      <div class="hubBrand">‚ôæÔ∏è digiy hub</div>
      <div class="hubTopBtns">
        <button class="hubBtn back" id="hubBackBtn" type="button">‚Üê retour hub</button>
        <button class="hubBtn close" id="hubCloseBtn" type="button">‚úñ fermer</button>
      </div>
    </div>
    <iframe id="hubFrame" title="Module DIGIY" allow="geolocation; camera; microphone" loading="lazy"></iframe>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
"use strict";

/* ‚úÖ SUPABASE */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

/* ‚úÖ ROUTES */
const L = {
  bonneAffaire:"https://beauville.github.io/digiy-bonne-affaire/",
  driver:"https://beauville.github.io/digiy-driver/",
  driverClient:"https://beauville.github.io/digiy-driver-client/",
  loc:"https://beauville.github.io/digiy-loc/",
  resto:"https://beauville.github.io/digiy-resto/",
  resaTable:"https://beauville.github.io/digiy-resa-table/",
  caissePro:"https://beauville.github.io/digiy-caisse-pro/",
  vasChez:"https://beauville.github.io/vas-chez-digiy/",
  pay:"https://beauville.github.io/digiy-pay/",
  build:"https://beauville.github.io/digiy-build/",
  market:"https://beauville.github.io/digiy-market/",
  job:"https://beauville.github.io/digiy-jobs/",
  explore:"https://beauville.github.io/digiy-explore/",
  notable:"https://beauville.github.io/digiy-notable/",
  /* ‚úÖ IMPORTANT: ton vrai lien */
  mdimbaMap:"https://beauville.github.io/digiy-mdimba-map/",
  inscription:"https://beauville.github.io/inscription-digiy/",
  inscriptionClient:"https://beauville.github.io/inscription-client.html",
  dashboard:"https://beauville.github.io/mon-espace-digiy/",
  espacePro:"https://beauville.github.io/espace-pro/",
  hubDrive:"https://beauville.github.io/digiy-hub-drive/",
  tarifs:"https://beauville.github.io/digiy/",
  paiementManuel:"./paiement-manuel.html"
};

/* ‚úÖ MODULES : c'est ici que tu g√®res ton HUB (ajout/suppression/ordre) */
const MODULES = [
  { key:"bonneAffaire", icon:"üí•", name:"digiy bonne affaire", tag:"bons plans ‚Ä¢ promos", badge:{type:"new", text:"officiel"}, desc:"Les meilleures opportunit√©s locales : promos, deals, bonnes affaires terrain." },
  { key:"driver", icon:"üöó", name:"digiy driver pro", tag:"chauffeur professionnel", badge:{type:"", text:"live"}, desc:"Accepter courses, GPS temps r√©el, encaissements directs." },
  { key:"driverClient", icon:"üöï", name:"digiy driver client", tag:"commander une course", badge:{type:"", text:"live"}, desc:"Commande ta course VTC au S√©n√©gal. Paiement direct. 0% commission." },
  { key:"caissePro", icon:"üßæ", name:"digiy caisse pro", tag:"pos + sync batch", badge:{type:"new", text:"nouveau"}, desc:"Caisse pro + sync ultra-l√©g√®re. Encaissement terrain." },
  { key:"vasChez", icon:"üèÉ", name:"vas chez digiy", tag:"coursier express", badge:{type:"new", text:"nouveau"}, desc:"Livraison & courses rapides. 0% commission. Paiement direct." },
  { key:"loc", icon:"üè†", name:"digiy loc", tag:"location sans ota", badge:{type:"", text:"live"}, desc:"Alternative Booking/Airbnb, sans commission, en direct propri√©taire." },
  { key:"resto", icon:"üçΩÔ∏è", name:"digiy resto", tag:"vitrine restaurant", badge:{type:"", text:"live"}, desc:"Menus, photos, horaires, localisation. R√©servation directe." },
  { key:"pay", icon:"üí≥", name:"digiy pay", tag:"wallet unifi√©", badge:{type:"prio", text:"priorit√©"}, desc:"Wave / OM / CB. Historique, suivi, activation modules." },

  /* Paiement manuel (badge dynamique) */
  { key:"paiementManuel", icon:"üßæ", name:"paiement manuel", tag:"nom + num√©ro", pill:true, desc:"D√©clare juste le receveur : Nom + Num√©ro. DIGIY n‚Äôest pas une banque." },

  { key:"build", icon:"üèóÔ∏è", name:"digiy build", tag:"artisans & btp", badge:{type:"", text:"live"}, desc:"Devis, galerie, contact. Humain. Direct. Sans commission." },
  { key:"market", icon:"üõçÔ∏è", name:"digiy market", tag:"marketplace locale", badge:{type:"prio", text:"priorit√©"}, desc:"Acheter/vendre local. Annonces propres. Sans commission." },
  { key:"job", icon:"üíº", name:"digiy jobs", tag:"emploi & talents", badge:{type:"prio", text:"priorit√©"}, desc:"Offres, candidatures, profils. Pont talents‚Äìemployeurs." },

  /* ‚úÖ mdimba map */
  { key:"mdimbaMap", icon:"üó∫Ô∏è", name:"digiy mdimba map", tag:"carte communaut√©", badge:{type:"free", text:"gratuit"}, desc:"Annuaire g√©olocalis√© du S√©n√©gal : pros, quartiers, filtres." },

  /* external (ouvre nouvel onglet) */
  { external:"https://beauville.github.io/commencer-a-payer/?product=DIGIY_FRET_CHAUFFEUR&role=driver", icon:"üöö", name:"digiy fret", tag:"transport marchandises", badge:{type:"new", text:"nouveau"}, desc:"Transport marchandises 0% commission. GPS, paiements directs." },

  { key:"inscriptionClient", icon:"‚ôæÔ∏è", name:"acc√®s client", tag:"inscription gratuite", badge:{type:"free", text:"gratuit"}, desc:"Cr√©e ton compte gratuit et acc√®de aux apps clients DIGIY." },
  { key:"inscription", icon:"üìù", name:"inscription pro", tag:"nouveau compte pro", badge:{type:"new", text:"nouveau"}, desc:"Inscription intelligente. Choisis ton module, on calcule ton tarif." },
  { key:"resaTable", icon:"ü™ë", name:"digiy resa table", tag:"r√©servation restaurant", badge:{type:"", text:"live"}, desc:"R√©servations de tables restaurant. Plan de salle, disponibilit√©s en temps r√©el." },
  { key:"notable", icon:"üìì", name:"digiy notable", tag:"notes & docs", badge:{type:"prio", text:"priorit√©"}, desc:"Notes, fiches terrain, proc√©dures. Organise ton savoir pro." },
  { key:"explore", icon:"üß≠", name:"digiy explore", tag:"tourisme & d√©couverte", badge:{type:"", text:"live"}, desc:"D√©couvrir l'Afrique ‚Ä¢ guides ‚Ä¢ visibilit√© ‚Ä¢ exp√©riences authentiques." }
];

/* helpers */
const qs = (s, r=document) => r.querySelector(s);
const esc = (s="") => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const on = (el, ev, fn, opt) => el && el.addEventListener(ev, fn, opt);

/* DOM */
const grid      = qs("#modulesGrid");
const hubOverlay= qs("#hubOverlay");
const hubFrame  = qs("#hubFrame");
const ndimbal   = qs("#digiy-ndimbal");
const qrModal   = qs("#qrModal");

/* show/hide */
function show(el){ if(!el) return; el.classList.add("show"); el.style.display="block"; el.style.pointerEvents="auto"; el.setAttribute("aria-hidden","false"); }
function hide(el){ if(!el) return; el.classList.remove("show"); el.style.display="none"; el.style.pointerEvents="none"; el.setAttribute("aria-hidden","true"); }

/* hub */
function openInside(url){
  hide(ndimbal); hide(qrModal);
  if(!hubOverlay || !hubFrame){ location.href=url; return; }
  hubFrame.src=url;
  show(hubOverlay);
  document.body.style.overflow="hidden";
}
function closeInside(){
  hide(hubOverlay);
  if(hubFrame) hubFrame.src="about:blank";
  document.body.style.overflow="";
}

/* ndimbal / qr */
function openNdimbal(){ show(ndimbal); }
function closeNdimbal(){ hide(ndimbal); }
function openQR(){ show(qrModal); }
function closeQR(){ hide(qrModal); }

/* ‚úÖ reset overlays */
on(window, "load", () => { try{ closeQR(); closeNdimbal(); closeInside(); }catch(e){} });

/* ‚úÖ render modules */
function badgeHTML(b){
  if(!b || !b.text) return "";
  const cls = b.type ? `badge ${esc(b.type)}` : "badge";
  return `<div class="${cls}">${esc(b.text)}</div>`;
}
function pillHTML(){
  return `
    <div class="payPill" id="payManualBadge">
      <span class="payDot" id="payManualDot"></span>
      <span id="payManualTxt">chargement</span>
    </div>`;
}
function moduleHTML(m){
  const attr = m.external
    ? `data-external="${esc(m.external)}"`
    : `data-open="${esc(m.key)}"`;

  return `
  <div class="module" ${attr}>
    <div class="module-top">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="module-icon">${esc(m.icon || "‚ôæÔ∏è")}</div>
        <div>
          <div class="module-name">${esc(m.name || "")}</div>
          <div class="module-tag">${esc(m.tag || "")}</div>
        </div>
      </div>
      ${m.pill ? pillHTML() : badgeHTML(m.badge)}
    </div>
    <div class="module-body">${esc(m.desc || "")}</div>
  </div>`;
}
function renderModules(){
  if(!grid) return;
  grid.innerHTML = MODULES.map(moduleHTML).join("");
}
renderModules();

/* ‚úÖ badge paiement manuel */
function getOwnerId(){
  const keys=["DIGIY_HUB_SESSION","DIGIY_LOC_PRO_SESSION","DIGIY_DRIVER_SESSION","DIGIY_BUILD_SESSION","DIGIY_EXPLORE_SESSION"];
  for(const k of keys){
    try{
      const raw=localStorage.getItem(k);
      if(!raw) continue;
      const s=JSON.parse(raw);
      const id=s.owner_id||s.ownerId||s.pro_id||s.user_id||s.uid||null;
      if(id) return id;
    }catch(e){}
  }
  return null;
}
function setPayManualBadge(state, text){
  const dot=qs("#payManualDot");
  const txt=qs("#payManualTxt");
  if(!dot||!txt) return;
  dot.classList.remove("green","red");
  if(state==="ok") dot.classList.add("green");
  if(state==="err") dot.classList.add("red");
  txt.textContent=(text||"");
}
async function digiyLoadManualPayStatus(sb){
  setPayManualBadge("", "chargement");
  const ownerId=getOwnerId();
  if(!ownerId){ setPayManualBadge("err","session?"); return; }
  const { data, error } = await sb.rpc("digiy_get_payment_manual", { p_owner_id: ownerId });
  if(error){ setPayManualBadge("err","erreur"); return; }
  if(data && data.manual_status==="ready") setPayManualBadge("ok","pr√™t");
  else setPayManualBadge("", "√† configurer");
}

/* ‚úÖ click handler UNIQUE (capture=true, blind√© anti-glitch) */
on(document, "click", (e) => {
  const t = e.target;

  const hardStop = () => {
    e.preventDefault(); e.stopPropagation();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
  };

  /* hub close buttons */
  const hubClose = t && t.closest ? t.closest("#hubBackBtn,#hubCloseBtn") : null;
  if(hubClose){ hardStop(); closeInside(); return; }

  /* click outside hub card */
  if(hubOverlay && t === hubOverlay){ hardStop(); closeInside(); return; }

  /* header buttons */
  if(t && t.closest && t.closest("#btnLogin")){ hardStop(); openInside(L.dashboard); return; }
  if(t && t.closest && t.closest("#btnGetHub")){ hardStop(); openInside(L.inscription); return; }
  if(t && t.closest && t.closest("#btnDeals")){ hardStop(); openInside(L.bonneAffaire); return; }

  /* floating buttons */
  if(t && t.closest && t.closest("#tarif-bubble-btn")){ hardStop(); openInside(L.tarifs); return; }
  if(t && t.closest && t.closest("#espace-pro-btn")){ hardStop(); openInside(L.espacePro); return; }
  if(t && t.closest && t.closest("#digiy-help-btn")){ hardStop(); openNdimbal(); return; }

  /* ndimbal close */
  if(t && t.closest && t.closest("#digiyCloseBtn")){ hardStop(); closeNdimbal(); return; }
  if(ndimbal && t === ndimbal){ hardStop(); closeNdimbal(); return; }

  /* ndimbal actions */
  const act = t && t.closest ? t.closest(".digiyAct") : null;
  if(act){
    hardStop();
    const action = act.getAttribute("data-action");
    closeNdimbal();
    if(action==="sell"){ openInside(L.hubDrive); return; }
    if(action==="job"){ openInside(L.job); return; }
    if(action==="qr"){ openQR(); return; }
    return;
  }

  /* qr close */
  if(t && t.closest && t.closest("#qrClose")){ hardStop(); closeQR(); return; }
  if(qrModal && t === qrModal){ hardStop(); closeQR(); return; }

  /* module cards */
  const card = t && t.closest ? t.closest(".module") : null;
  if(card){
    hardStop();
    const ext = card.getAttribute("data-external");
    if(ext){ window.open(ext,"_blank","noopener"); return; }
    const key = card.getAttribute("data-open");
    if(key && L[key]){ openInside(L[key]); }
    return;
  }

  /* brand home */
  if(t && t.closest && t.closest("#homeBrand")){
    hardStop();
    closeInside();
    window.scrollTo({top:0,behavior:"smooth"});
    return;
  }

}, true);

/* esc */
on(document, "keydown", (e) => {
  if(e.key !== "Escape") return;
  if(qrModal && qrModal.classList.contains("show")) closeQR();
  else if(ndimbal && ndimbal.classList.contains("show")) closeNdimbal();
  else if(hubOverlay && hubOverlay.classList.contains("show")) closeInside();
});

/* init supabase badge */
try{
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  digiyLoadManualPayStatus(sb);
}catch(e){
  setPayManualBadge("err","erreur");
}

})();
</script>

</body>
</html>
