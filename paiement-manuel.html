<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#061b14"/>
  <title>DIGIY HUB ‚Äî Paiement Manuel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.12);
      --text:#eafff1; --muted:rgba(234,255,241,.72);
      --gold:#facc15; --green:#22c55e; --red:#fb7185;
      --shadow:0 14px 40px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:22px; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 20% -10%, rgba(250,204,21,.10), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(34,197,94,.08), transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:860px;margin:0 auto}
    .top{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line); border-radius:999px;
      padding:7px 10px; font-weight:800; font-size:12px;
      background:rgba(255,255,255,.04);
    }
    .dot{width:9px;height:9px;border-radius:999px;background:rgba(250,204,21,1)}
    .dot.green{background:rgba(34,197,94,1)}
    .dot.red{background:rgba(251,113,133,1)}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{
      padding:16px; display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(11,42,31,.55), rgba(10,36,27,.20));
    }
    h1{margin:0;font-size:16px}
    p{margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .bd{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{
      width:100%; padding:12px; border-radius:14px;
      background:rgba(0,0,0,.18); border:1px solid var(--line);
      color:var(--text); outline:none;
    }
    input:focus{border-color:rgba(250,204,21,.55); box-shadow:0 0 0 3px rgba(250,204,21,.10)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); padding:12px 14px; border-radius:14px;
      font-weight:900; cursor:pointer;
    }
    .btn.primary{
      border-color:rgba(250,204,21,.30);
      background:linear-gradient(180deg, rgba(250,204,21,.18), rgba(250,204,21,.10));
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .msg{margin-top:10px;font-size:13px}
    .msg.ok{color:rgba(34,197,94,1)}
    .msg.err{color:rgba(251,113,133,1)}
    .note{
      margin-top:10px; font-size:12px; color:var(--muted);
      border-top:1px solid var(--line); padding-top:10px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="badge"><span class="dot" id="statusDot"></span><span id="statusTxt">MANUEL ‚Äî chargement‚Ä¶</span></div>
    <div class="badge">DIGIY PAY ‚Äî 0% commission</div>
    <div class="badge"><span class="mono" id="ownerShort">owner: ‚Äî</span></div>
  </div>

  <div class="card">
    <div class="hd">
      <div>
        <h1>Paiement Manuel (Nom + Num√©ro)</h1>
        <p>On n‚Äôest pas une banque. Tu d√©clares juste <b>Nom</b> + <b>Num√©ro</b>. Le reste suit.</p>
      </div>
      <div class="badge"><span class="mono" id="lastUpdate">maj: ‚Äî</span></div>
    </div>

    <div class="bd">
      <div class="grid">
        <div>
          <label for="paymentName">Nom du receveur</label>
          <input id="paymentName" placeholder="Ex: Astou Ndiaye" autocomplete="name">
        </div>
        <div>
          <label for="paymentPhone">Num√©ro Wave / Orange</label>
          <input id="paymentPhone" placeholder="Ex: +221 77 999 00 11" autocomplete="tel">
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="btnSave">‚úÖ Enregistrer</button>
        <button class="btn" id="btnReload">üîÑ Recharger</button>
      </div>

      <div class="msg" id="msg"></div>

      <div class="note">
        <b>Note :</b> Wave/Orange sont externes. Le pro fait ses d√©marches. DIGIY g√®re juste le statut ‚Äúpr√™t‚Äù (manuel).
      </div>
    </div>
  </div>

</div>

<script>
/** =========================
 *  CONFIG SUPABASE (√† remplir)
 *  ========================= */
const SUPABASE_URL = "https://XXXXXXXXXXXX.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6...";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** =========================
 *  SESSION DIGIY (owner_id)
 *  ========================= */
function getDigiySession() {
  const keys = [
    "DIGIY_HUB_SESSION",
    "DIGIY_LOC_PRO_SESSION",
    "DIGIY_DRIVER_SESSION",
    "DIGIY_BUILD_SESSION",
    "DIGIY_EXPLORE_SESSION"
  ];
  for (const k of keys) {
    try {
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      const s = JSON.parse(raw);
      const owner_id = s.owner_id || s.ownerId || s.pro_id || s.user_id || s.uid || null;
      if (owner_id) return { owner_id, key: k };
    } catch(e) {}
  }
  return null;
}

function shortId(x){ return x ? (x.slice(0,8) + "‚Ä¶" + x.slice(-4)) : "‚Äî"; }

function setStatus(state, text) {
  const dot = document.getElementById("statusDot");
  dot.classList.remove("green","red");
  if (state === "ok") dot.classList.add("green");
  if (state === "err") dot.classList.add("red");
  document.getElementById("statusTxt").textContent = text;
}

function showMsg(type, text) {
  const el = document.getElementById("msg");
  el.className = "msg " + (type || "");
  el.textContent = text || "";
}

function normalizePhone(x){
  return (x||"").trim().replace(/\s+/g," ");
}

function fmtIso(iso){
  if(!iso) return "‚Äî";
  try{
    const d = new Date(iso);
    return d.toISOString().replace("T"," ").replace("Z"," UTC");
  }catch(e){ return iso; }
}

async function rpcGet(ownerId){
  return await sb.rpc("digiy_get_payment_manual", { p_owner_id: ownerId });
}

async function rpcSet(ownerId, name, phone){
  return await sb.rpc("digiy_set_payment_manual", {
    p_owner_id: ownerId,
    p_payment_name: name,
    p_payment_phone: phone
  });
}

async function boot(){
  showMsg("", "");
  setStatus("", "MANUEL ‚Äî chargement‚Ä¶");

  const sess = getDigiySession();
  if(!sess){
    setStatus("err", "MANUEL ‚Äî session introuvable");
    document.getElementById("ownerShort").textContent = "owner: introuvable";
    showMsg("err", "Owner_id introuvable dans localStorage. Ouvre ton HUB/guard puis reviens.");
    return;
  }

  const ownerId = sess.owner_id;
  document.getElementById("ownerShort").textContent = "owner: " + shortId(ownerId);

  const { data, error } = await rpcGet(ownerId);
  if(error){
    console.error(error);
    setStatus("err", "MANUEL ‚Äî erreur RPC");
    showMsg("err", "Erreur RPC (get). V√©rifie permissions / function.");
    return;
  }

  if(data?.manual_status === "ready"){
    document.getElementById("paymentName").value = data.payment_name || "";
    document.getElementById("paymentPhone").value = data.payment_phone || "";
    document.getElementById("lastUpdate").textContent = "maj: " + fmtIso(data.updated_at);
    setStatus("ok", "MANUEL ‚Äî pr√™t √† recevoir");
  } else {
    document.getElementById("paymentName").value = "";
    document.getElementById("paymentPhone").value = "";
    document.getElementById("lastUpdate").textContent = "maj: ‚Äî";
    setStatus("", "MANUEL ‚Äî √† configurer");
  }
}

document.getElementById("btnReload").addEventListener("click", boot);

document.getElementById("btnSave").addEventListener("click", async () => {
  showMsg("", "");
  const btn = document.getElementById("btnSave");
  btn.disabled = true;

  try{
    const sess = getDigiySession();
    if(!sess) throw new Error("session_missing");

    const ownerId = sess.owner_id;
    const name = (document.getElementById("paymentName").value || "").trim();
    const phone = normalizePhone(document.getElementById("paymentPhone").value);

    if(name.length < 2){ showMsg("err","Nom obligatoire."); btn.disabled=false; return; }
    if(phone.length < 6){ showMsg("err","Num√©ro obligatoire."); btn.disabled=false; return; }

    const { data, error } = await rpcSet(ownerId, name, phone);
    if(error){
      console.error(error);
      setStatus("err","MANUEL ‚Äî sauvegarde KO");
      showMsg("err","Sauvegarde KO (RPC).");
      btn.disabled = false;
      return;
    }

    if(data?.ok){
      setStatus("ok","MANUEL ‚Äî pr√™t √† recevoir");
      showMsg("ok","‚úÖ Enregistr√©. Nom + Num√©ro OK.");
      await boot(); // refresh infos + updated_at
    } else {
      setStatus("err","MANUEL ‚Äî refus");
      showMsg("err","Refus: " + (data?.reason || "unknown"));
    }
  } catch(e){
    console.error(e);
    setStatus("err","MANUEL ‚Äî erreur");
    showMsg("err","Erreur interne.");
  } finally {
    btn.disabled = false;
  }
});

boot();
</script>
</body>
</html>
