<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>DIGIY CORE HUB ‚Äî Lecture seule+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="DIGIY CORE HUB ‚Äî Vue d'ensemble des partenaires (lecture seule + recherche + filtres)">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#020617;
      --card:#020617;
      --accent:#facc15;
      --accent-soft:#f97316;
      --ink:#f9fafb;
      --muted:#9ca3af;
      --line:#1f2937;
      --danger:#ef4444;
      --good:#22c55e;
      --info:#38bdf8;
      --warn:#eab308;
    }
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,sans-serif;
    }
    body{
      min-height:100vh;
      background:radial-gradient(circle at top,#0f172a 0,#020617 55%);
      color:var(--ink);
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:1100px;
    }
    header{
      padding:16px 20px 8px;
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .title-block h1{
      font-size:1.3rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--accent);
    }
    .title-block p{
      font-size:.85rem;
      color:var(--muted);
      margin-top:4px;
    }
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .chip{
      font-size:.75rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,.7);
      backdrop-filter:blur(10px);
    }
    .chip-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--good);
      box-shadow:0 0 0 4px rgba(34,197,94,.2);
    }
    .actions{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:220px;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:.8rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,.8);
      color:var(--ink);
      border:1px solid rgba(148,163,184,.6);
    }
    .btn span.icon{
      font-size:1rem;
    }
    .badge-soft{
      font-size:.7rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      color:var(--muted);
      background:rgba(15,23,42,.6);
    }

    main{
      padding:0 16px 20px;
    }
    .card{
      background:radial-gradient(circle at top left,#111827 0,#020617 55%);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 45px rgba(15,23,42,.9);
      overflow:hidden;
    }
    .card-header{
      padding:14px 16px 10px;
      border-bottom:1px solid rgba(31,41,55,.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .card-header h2{
      font-size:.95rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    .card-header small{
      color:var(--muted);
      font-size:.75rem;
    }
    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      margin-right:6px;
      background:var(--good);
    }
    .status-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.75rem;
      color:var(--muted);
    }

    .filters{
      padding:10px 16px 8px;
      border-bottom:1px solid rgba(31,41,55,.9);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .filters-section{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      margin-right:10px;
    }
    .filters-label{
      font-size:.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .filter-chip{
      font-size:.7rem;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      color:var(--muted);
      background:rgba(15,23,42,.7);
      cursor:pointer;
    }
    .filter-chip.active{
      border-color:var(--accent);
      color:var(--accent);
      background:rgba(250,204,21,.08);
    }
    .search-input{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.8);
      color:var(--ink);
      font-size:.8rem;
      min-width:180px;
    }
    .search-input::placeholder{
      color:var(--muted);
    }
    .select{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.8);
      color:var(--ink);
      font-size:.75rem;
    }

    .table-wrapper{
      overflow-x:auto;
      max-height:65vh;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      min-width:780px;
    }
    thead{
      position:sticky;
      top:0;
      background:rgba(15,23,42,.98);
      backdrop-filter:blur(8px);
      z-index:5;
    }
    th,td{
      padding:10px 12px;
      text-align:left;
      border-bottom:1px solid rgba(31,41,55,.9);
      vertical-align:top;
    }
    th{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }
    tbody tr:hover{
      background:rgba(15,23,42,.7);
    }
    .partner-name{
      font-weight:600;
      color:var(--ink);
      font-size:.85rem;
    }
    .partner-id{
      font-size:.7rem;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:3px 9px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(148,163,184,.4);
      color:var(--muted);
      gap:6px;
    }
    .pill-dot{
      width:7px;
      height:7px;
      border-radius:999px;
    }
    .pill-dot.good{background:var(--good);}
    .pill-dot.bad{background:var(--danger);}
    .pill-dot.info{background:var(--info);}
    .pill-dot.warn{background:var(--warn);}
    .modules-list{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .module-badge{
      font-size:.7rem;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      color:var(--muted);
      background:rgba(15,23,42,.6);
    }
    .module-badge.active{
      border-color:var(--accent);
      color:var(--accent);
      background:rgba(250,204,21,.06);
    }
    .link-list{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .link-list a{
      font-size:.7rem;
      color:var(--info);
      text-decoration:none;
      word-break:break-all;
    }
    .link-list a:hover{
      text-decoration:underline;
    }
    .muted{
      color:var(--muted);
      font-size:.75rem;
    }
    .empty{
      padding:16px;
      text-align:center;
      font-size:.8rem;
      color:var(--muted);
    }
    footer{
      padding:10px 18px 0;
      font-size:.7rem;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    @media (max-width:768px){
      header{
        padding:12px;
      }
      main{
        padding:0 8px 16px;
      }
      .card{
        border-radius:14px;
      }
      .filters{
        padding:8px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>DIGIY CORE ‚Ä¢ HUB</h1>
        <p>Vue d‚Äôensemble lecture seule des partenaires connect√©s √† l‚Äô√©cosyst√®me DIGIY.</p>
        <div class="chip-row">
          <div class="chip">
            <div class="chip-dot"></div>
            Base : Realtime Database (digiylyfe-ecosystem)
          </div>
          <div class="chip">
            üîê Lecture publique ‚Ä¢ √âcriture ferm√©e
          </div>
        </div>
      </div>
      <div class="actions">
        <input id="searchInput" class="search-input" type="text" placeholder="Rechercher (nom, ville, module‚Ä¶)" />
        <button class="btn" id="refreshBtn">
          <span class="icon">üîÑ</span>
          Rafra√Æchir les donn√©es
        </button>
        <div class="badge-soft" id="lastUpdated">Derni√®re mise √† jour : ‚Äî</div>
      </div>
    </header>

    <main>
      <div class="card">
        <div class="card-header">
          <div>
            <h2>PARTENAIRES ACTIV√âS</h2>
            <small id="summaryText">Chargement des donn√©es‚Ä¶</small>
          </div>
          <div class="status-row">
            <span class="status-dot"></span>
            <span id="statusText">Connect√© √† Firebase</span>
          </div>
        </div>

        <!-- Filtres -->
        <div class="filters">
          <div class="filters-section">
            <span class="filters-label">Modules</span>
            <button class="filter-chip active" data-filter-module="all">Tous</button>
            <button class="filter-chip" data-filter-module="pos">POS</button>
            <button class="filter-chip" data-filter-module="loc">LOC</button>
            <button class="filter-chip" data-filter-module="driver">DRIVER</button>
            <button class="filter-chip" data-filter-module="pay">PAY</button>
          </div>
          <div class="filters-section">
            <span class="filters-label">Statut</span>
            <button class="filter-chip active" data-filter-status="all">Tous</button>
            <button class="filter-chip" data-filter-status="active">Actifs</button>
            <button class="filter-chip" data-filter-status="nonactive">Non actifs</button>
          </div>
          <div class="filters-section">
            <span class="filters-label">Alliance</span>
            <select id="allianceFilter" class="select">
              <option value="all">Toutes</option>
            </select>
          </div>
        </div>

        <div class="table-wrapper" id="tableWrapper">
          <div class="empty" id="emptyState">Lecture des partenaires en cours‚Ä¶</div>
          <table style="display:none" id="partnersTable">
            <thead>
              <tr>
                <th>Partenaire</th>
                <th>Ville / Pays</th>
                <th>Alliance</th>
                <th>Modules actifs</th>
                <th>Liens</th>
                <th>Statut</th>
                <th>Cr√©√© le</th>
                <th>Contact</th>
                <th>Rappel SMS</th>
              </tr>
            </thead>
            <tbody id="partnersBody">
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <footer>
      <div>DIGIYLYFE ‚Ä¢ Vue CORE lecture seule ‚Äî terrain Saly & alliances.</div>
      <div>Data: /astou-boutique, /chez-baptiste (√©volutif vers /partners plus tard).</div>
    </footer>
  </div>

  <script>
    // ===== CONFIG FIREBASE (digiylyfe-ecosystem) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBqEQWoE2iC7_rp-u4riilNVHolcP2o0B0",
      authDomain: "digiylyfe-ecosystem.firebaseapp.com",
      databaseURL: "https://digiylyfe-ecosystem-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "digiylyfe-ecosystem",
      storageBucket: "digiylyfe-ecosystem.firebasestorage.app",
      messagingSenderId: "1007962643384",
      appId: "1:1007962643384:web:20d26881e87f0dc37d0d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const statusText = document.getElementById('statusText');
    const summaryText = document.getElementById('summaryText');
    const lastUpdated = document.getElementById('lastUpdated');
    const emptyState = document.getElementById('emptyState');
    const partnersTable = document.getElementById('partnersTable');
    const partnersBody = document.getElementById('partnersBody');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput = document.getElementById('searchInput');
    const allianceFilterSelect = document.getElementById('allianceFilter');

    let allPartners = [];
    let currentModuleFilter = "all";
    let currentStatusFilter = "all";
    let currentAllianceFilter = "all";
    let currentSearch = "";

    function formatDate(ts){
      if(!ts){ return "‚Äî"; }
      try{
        const d = new Date(Number(ts));
        if(isNaN(d.getTime())) return "‚Äî";
        return d.toLocaleString('fr-FR', {
          year:'numeric',
          month:'2-digit',
          day:'2-digit',
          hour:'2-digit',
          minute:'2-digit'
        });
      }catch(e){
        return "‚Äî";
      }
    }

    function isLikelyPartner(key, value){
      if(!value || typeof value !== 'object') return false;
      if(key === 'coreUsers' || key === 'tenants' || key === 'alliances' || key === 'alerts' || key === 'pulse'){
        return false;
      }
      if(value.name && value.modules){
        return true;
      }
      return false;
    }

    function buildAllianceFilterOptions(partners){
      const alliances = new Set();
      partners.forEach(p => {
        if(p.allianceId){
          alliances.add(p.allianceId);
        }
      });
      allianceFilterSelect.innerHTML = '<option value="all">Toutes</option>';
      Array.from(alliances).sort().forEach(a => {
        const opt = document.createElement('option');
        opt.value = a;
        opt.textContent = a;
        allianceFilterSelect.appendChild(opt);
      });
    }

    function applyFiltersAndRender(){
      let filtered = allPartners.slice();

      // Texte de recherche (sur plusieurs champs)
      if(currentSearch.trim() !== ""){
        const q = currentSearch.toLowerCase();
        filtered = filtered.filter(p => {
          const fields = [
            p.id,
            p.name || "",
            p.city || "",
            p.country || "",
            p.allianceId || "",
            (p.status || ""),
            (p.owner && p.owner.name) || "",
            (p.owner && p.owner.phone) || "",
            (p.owner && p.owner.email) || ""
          ];
          // modules + liens dans la recherche
          if(p.modules){
            Object.keys(p.modules).forEach(k => fields.push(k + ":" + (p.modules[k] ? "on" : "off")));
          }
          if(p.links){
            Object.values(p.links).forEach(v => fields.push(String(v || "")));
          }
          const haystack = fields.join(" ").toLowerCase();
          return haystack.includes(q);
        });
      }

      // Filtre module
      if(currentModuleFilter !== "all"){
        filtered = filtered.filter(p => p.modules && p.modules[currentModuleFilter]);
      }

      // Filtre statut
      if(currentStatusFilter === "active"){
        filtered = filtered.filter(p => (p.status || "").toLowerCase() === "active");
      }else if(currentStatusFilter === "nonactive"){
        filtered = filtered.filter(p => {
          const s = (p.status || "").toLowerCase();
          return s && s !== "active";
        });
      }

      // Filtre alliance
      if(currentAllianceFilter !== "all"){
        filtered = filtered.filter(p => (p.allianceId || "") === currentAllianceFilter);
      }

      renderPartners(filtered);
    }

    function renderPartners(partners){
      if(!partners || partners.length === 0){
        partnersTable.style.display = 'none';
        emptyState.style.display = 'block';
        emptyState.textContent = "Aucun partenaire ne correspond aux crit√®res.";
        summaryText.textContent = "0 partenaire filtr√©.";
        return;
      }

      partnersBody.innerHTML = '';
      partners.forEach(p => {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.innerHTML = `
          <div class="partner-name">${p.name || '‚Äî'}</div>
          <div class="partner-id">${p.id}</div>
        `;

        const tdCity = document.createElement('td');
        tdCity.innerHTML = `
          <div>${p.city || '‚Äî'}</div>
          <div class="muted">${p.country || ''}</div>
        `;

        const tdAlliance = document.createElement('td');
        tdAlliance.innerHTML = `
          <span class="pill">
            <span class="pill-dot info"></span>
            ${p.allianceId || '‚Äî'}
          </span>
        `;

        const tdModules = document.createElement('td');
        const modulesDiv = document.createElement('div');
        modulesDiv.className = 'modules-list';
        const moduleLabels = { pos: 'POS', loc: 'LOC', driver: 'DRIVER', pay: 'PAY' };
        if(p.modules){
          Object.keys(moduleLabels).forEach(k => {
            const span = document.createElement('span');
            const active = !!p.modules[k];
            span.className = 'module-badge' + (active ? ' active':'');
            span.textContent = moduleLabels[k];
            modulesDiv.appendChild(span);
          });
        } else {
          const span = document.createElement('span');
          span.className = 'muted';
          span.textContent = '‚Äî';
          modulesDiv.appendChild(span);
        }
        tdModules.appendChild(modulesDiv);

        const tdLinks = document.createElement('td');
        const linksDiv = document.createElement('div');
        linksDiv.className = 'link-list';
        if(p.links){
          if(p.links.pos && p.links.pos !== '#'){
            const a = document.createElement('a');
            a.href = p.links.pos;
            a.target = '_blank';
            a.textContent = 'POS';
            linksDiv.appendChild(a);
          }
          if(p.links.loc && p.links.loc !== '#'){
            const a = document.createElement('a');
            a.href = p.links.loc;
            a.target = '_blank';
            a.textContent = 'LOC';
            linksDiv.appendChild(a);
          }
          if(p.links.driver && p.links.driver !== '#'){
            const a = document.createElement('a');
            a.href = p.links.driver;
            a.target = '_blank';
            a.textContent = 'DRIVER';
            linksDiv.appendChild(a);
          }
          if(p.links.pay && p.links.pay !== '#'){
            const a = document.createElement('a');
            a.href = p.links.pay;
            a.target = '_blank';
            a.textContent = 'PAY';
            linksDiv.appendChild(a);
          }
        }
        if(!linksDiv.children.length){
          const span = document.createElement('span');
          span.className = 'muted';
          span.textContent = '‚Äî';
          linksDiv.appendChild(span);
        }
        tdLinks.appendChild(linksDiv);

        const tdStatus = document.createElement('td');
        const status = (p.status || '').toLowerCase();
        let dotClass = 'info';
        let label = p.status || '‚Äî';
        if(status === 'active'){
          dotClass = 'good';
        }else if(status === 'inactive' || status === 'blocked'){
          dotClass = 'bad';
        }else if(!status){
          dotClass = 'warn';
          label = 'inconnu';
        }
        tdStatus.innerHTML = `
          <span class="pill">
            <span class="pill-dot ${dotClass}"></span>
            ${label}
          </span>
        `;

        const tdCreated = document.createElement('td');
        tdCreated.textContent = formatDate(p.createdAt);

        const tdOwner = document.createElement('td');
        if(p.owner){
          tdOwner.innerHTML = `
            <div>${p.owner.name || '‚Äî'}</div>
            <div class="muted">${p.owner.phone || ''}</div>
            <div class="muted">${p.owner.email || ''}</div>
          `;
        }else{
          tdOwner.innerHTML = `<span class="muted">‚Äî</span>`;
        }

        // Rappel SMS
        const tdReminder = document.createElement('td');
        const reminder = p.reminder || {};
        const needSms = !!reminder.needSms;
        const lastSmsAt = reminder.lastSmsAt ? formatDate(reminder.lastSmsAt) : '‚Äî';
        const note = reminder.note || '';

        let rDotClass = 'good';
        let rLabel = 'OK';
        if(needSms){
          rDotClass = 'warn';
          rLabel = '√Ä rappeler';
        }
        tdReminder.innerHTML = `
          <div class="pill">
            <span class="pill-dot ${rDotClass}"></span>
            ${rLabel}
          </div>
          <div class="muted" style="margin-top:4px;">Dernier SMS : ${lastSmsAt}</div>
          ${note ? `<div class="muted">${note}</div>` : ''}
        `;

        tr.appendChild(tdName);
        tr.appendChild(tdCity);
        tr.appendChild(tdAlliance);
        tr.appendChild(tdModules);
        tr.appendChild(tdLinks);
        tr.appendChild(tdStatus);
        tr.appendChild(tdCreated);
        tr.appendChild(tdOwner);
        tr.appendChild(tdReminder);

        partnersBody.appendChild(tr);
      });

      partnersTable.style.display = 'table';
      emptyState.style.display = 'none';
      summaryText.textContent = `${partners.length} partenaire(s) filtr√©(s) sur ${allPartners.length} total.`;
    }

    function loadPartners(){
      statusText.textContent = "Lecture en cours‚Ä¶";
      emptyState.style.display = 'block';
      partnersTable.style.display = 'none';
      emptyState.textContent = "Lecture des partenaires en cours‚Ä¶";

      db.ref('/').once('value')
        .then(snap => {
          const partners = [];
          snap.forEach(child => {
            const key = child.key;
            const val = child.val();
            if(isLikelyPartner(key, val)){
              partners.push({
                id: key,
                name: val.name || key,
                city: val.city || '',
                country: val.country || '',
                status: val.status || '',
                allianceId: val.allianceId || '',
                modules: val.modules || null,
                links: val.links || null,
                createdAt: val.createdAt || null,
                owner: val.owner || null,
                reminder: val.reminder || null
              });
            }
          });
          partners.sort((a,b) => {
            const ta = Number(a.createdAt || 0);
            const tb = Number(b.createdAt || 0);
            return tb - ta;
          });
          allPartners = partners;
          buildAllianceFilterOptions(allPartners);
          applyFiltersAndRender();
          statusText.textContent = "Connect√© √† Firebase ‚Ä¢ Lecture seule";
          const now = new Date();
          lastUpdated.textContent = "Derni√®re mise √† jour : " + now.toLocaleTimeString('fr-FR', {
            hour:'2-digit',
            minute:'2-digit',
            second:'2-digit'
          });
        })
        .catch(err => {
          console.error(err);
          statusText.textContent = "Erreur de lecture Firebase";
          emptyState.style.display = 'block';
          partnersTable.style.display = 'none';
          emptyState.textContent = "Erreur de lecture : " + (err && err.message ? err.message : 'inconnue');
          summaryText.textContent = "Impossible de charger les partenaires.";
        });
    }

    // Events filtres
    refreshBtn.addEventListener('click', () => {
      loadPartners();
    });

    searchInput.addEventListener('input', (e) => {
      currentSearch = e.target.value || "";
      applyFiltersAndRender();
    });

    document.querySelectorAll('[data-filter-module]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-filter-module]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentModuleFilter = btn.getAttribute('data-filter-module');
        applyFiltersAndRender();
      });
    });

    document.querySelectorAll('[data-filter-status]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-filter-status]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStatusFilter = btn.getAttribute('data-filter-status');
        applyFiltersAndRender();
      });
    });

    allianceFilterSelect.addEventListener('change', () => {
      currentAllianceFilter = allianceFilterSelect.value || "all";
      applyFiltersAndRender();
    });

    // Chargement initial
    loadPartners();
  </script>
</body>
</html>
