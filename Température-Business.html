<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#061b14"/>
  <title>DIGIY ‚Äî Temp√©rature Business</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Guard DIGIY -->
  <script src="./guard.js?v=swarm-peuple-6"></script>

  <style>
    :root{
      --bg:#061b14;
      --card:#0b2a1f;
      --line:rgba(255,255,255,.12);
      --text:#eafff1;
      --muted:rgba(234,255,241,.7);

      --gold:#facc15;
      --green:#22c55e;
      --orange:#f59e0b;
      --red:#ef4444;

      --radius:20px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,sans-serif;
      background:radial-gradient(circle at 20% 10%, rgba(250,204,21,.12), transparent 55%),
                 radial-gradient(circle at 80% 90%, rgba(34,197,94,.10), transparent 60%),
                 var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px;
    }

    .logo{
      font-size:28px;
      font-weight:900;
      color:var(--gold);
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .status{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:13px;
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }

    /* üîë mini barre action */
    .topActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin:10px 0 12px;
    }
    .linkBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:var(--text);
      text-decoration:none;
      font-weight:950;
      font-size:13px;
      transition: transform .08s ease, opacity .08s ease;
    }
    .linkBtn:active{transform:translateY(1px); opacity:.92}

    /* üö® URGENCE BAR */
    .urgentBar{
      display:none;
      margin:10px 0 14px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(239,68,68,.55);
      background:rgba(239,68,68,.12);
      box-shadow:0 14px 30px rgba(0,0,0,.35);
    }
    .urgentRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .urgentTitle{ font-weight:950; font-size:15px; }
    .urgentText{ font-size:13px; opacity:.9; margin-top:4px; }
    .urgentBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
      transition: transform .08s ease, opacity .08s ease;
    }
    .urgentBtn:active{transform:translateY(1px); opacity:.92}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
    }

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
      text-align:center;
      position:relative;
      overflow:hidden;
    }

    .title{
      font-size:16px;
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    /* üî¥ Badge D√õ */
    .dueBadge{
      display:none;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      border:1px solid rgba(239,68,68,.65);
      background:rgba(239,68,68,.14);
    }

    @keyframes digiyPulse{
      0%   { transform: scale(1);    box-shadow:0 0 0 rgba(239,68,68,0); }
      50%  { transform: scale(1.04); box-shadow:0 0 22px rgba(239,68,68,.22); }
      100% { transform: scale(1);    box-shadow:0 0 0 rgba(239,68,68,0); }
    }
    .duePulse{ animation: digiyPulse 1.05s ease-in-out infinite; }

    @media (prefers-reduced-motion: reduce){
      .duePulse{ animation:none !important; }
      .urgentBtn{ transition:none !important; }
      .linkBtn{ transition:none !important; }
    }

    .value{
      font-size:46px;
      font-weight:950;
      margin:8px 0;
      color:var(--gold);
      line-height:1;
    }

    .hint{
      font-size:13px;
      color:var(--muted);
    }

    .tempBox{
      margin-top:18px;
      padding:16px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      text-align:center;
    }

    .temp{
      font-size:28px;
      font-weight:950;
      margin-top:8px;
    }

    .subTemp{
      margin-top:6px;
      font-size:12px;
      color:rgba(234,255,241,.55);
    }

    footer{
      margin-top:18px;
      text-align:center;
      font-size:12px;
      color:rgba(234,255,241,.35);
    }
  </style>
</head>

<body>

<header>
  <div class="logo">‚ôæÔ∏è DIGIY</div>
  <div class="status" id="status" aria-live="polite">Chargement‚Ä¶</div>
</header>

<!-- üîë Actions -->
<div class="topActions">
  <a class="linkBtn" href="./login.html">üîë Se connecter</a>
  <a class="linkBtn" href="./">üè† HUB</a>
</div>

<!-- üö® URGENCE -->
<div class="urgentBar" id="urgentBar">
  <div class="urgentRow">
    <div>
      <div class="urgentTitle">üö® URGENCE</div>
      <div class="urgentText" id="urgentText">Message √† envoyer maintenant.</div>
    </div>
    <button class="urgentBtn" id="urgentBtn" type="button">Voir</button>
  </div>
</div>

<div class="grid">
  <div class="card">
    <div class="title">R√©servations</div>
    <div class="value" id="kpiResa">‚Ä¶</div>
    <div class="hint">S√©jours confirm√©s</div>
  </div>

  <div class="card">
    <div class="title">Solde Wallet</div>
    <div class="value" id="kpiWallet">‚Ä¶</div>
    <div class="hint">Argent disponible</div>
  </div>

  <div class="card">
    <div class="title">Clients demain</div>
    <div class="value" id="kpiTomorrow">‚Ä¶</div>
    <div class="hint">Arriv√©es pr√©vues</div>
  </div>

  <div class="card" id="msgCard">
    <div class="title">
      Messages
      <span class="dueBadge" id="dueBadge">D√õ</span>
    </div>
    <div class="value" id="kpiMsg">‚Ä¶</div>
    <div class="hint">
      Rappels pr√©vus : <span id="msgPlanned">0</span>
      ‚Ä¢ Urgent maintenant : <span id="msgDue">0</span>
      ‚Ä¢ Pr√©vu demain : <span id="msgTomorrow">0</span>
    </div>
  </div>

  <div class="card">
    <div class="title">Ventes aujourd‚Äôhui</div>
    <div class="value" id="kpiSalesToday">‚Ä¶</div>
    <div class="hint">Tickets (caisse)</div>
  </div>

  <div class="card">
    <div class="title">CA aujourd‚Äôhui</div>
    <div class="value" id="kpiTurnoverToday">‚Ä¶</div>
    <div class="hint">Total (FCFA)</div>
  </div>

  <div class="card">
    <div class="title">Panier moyen</div>
    <div class="value" id="kpiAvgBasket">‚Ä¶</div>
    <div class="hint">Moyenne / ticket</div>
  </div>
</div>

<!-- ‚úÖ Temp√©rature Globale -->
<div class="tempBox">
  üå°Ô∏è Temp√©rature Business
  <div class="temp" id="tempLevel">‚Ä¶</div>
  <div class="subTemp" id="subTemp">‚Äî</div>
</div>

<footer>DIGIY ‚Ä¢ Ensemble, on avance ‚ôæÔ∏è</footer>

<script>
/* ===============================
   DIGIY SWARM ‚Äî Temp√©rature Business (SESSION MODE)
   - Guard d√©j√† charg√© (window.__digiy_sb__ / window.supa)
   - Session obligatoire (owner_id + phone)
   - Redirection vers login si absent
================================ */

function $(id){ return document.getElementById(id); }

console.log("‚úÖ SWARM DASHBOARD LOADED", location.href);

const TZ = "Africa/Dakar";
const NF = new Intl.NumberFormat("fr-FR");

function moneyFCFA(v){
  const n = Number(v || 0);
  return NF.format(isFinite(n) ? n : 0);
}

function nowLabel(){
  const d = new Date();
  try { return d.toLocaleString("fr-FR", { timeZone: TZ }); } catch(e){ return d.toISOString(); }
}

function fmtDate(v){
  if(!v) return "‚Äî";
  const d = new Date(v);
  if(isNaN(d.getTime())) return "‚Äî";
  try { return d.toLocaleString("fr-FR", { timeZone: TZ }); } catch(e){ return d.toISOString(); }
}

function getSession(){
  const raw =
    localStorage.getItem("DIGIY_LOC_PRO_SESSION_V1") ||
    localStorage.getItem("DIGIY_SESSION_V1") ||
    "{}";
  try { return JSON.parse(raw); } catch(e){ return {}; }
}

function safeLabel(x){
  const s = String(x || "").trim();
  if(!s) return "‚ùÑÔ∏è Calme";
  return s.replace(/[\u0000-\u001F\u007F]/g, "");
}

function requireSession(){
  const sess = getSession();
  const ownerId = sess.owner_id;
  const phone = sess.phone || sess.phone_number || sess.tel;

  if(!ownerId || !phone){
    $("status").textContent = "üîê Connexion requise‚Ä¶";
    setTimeout(()=>{ location.href = "./login.html"; }, 900);
    return null;
  }
  return { ownerId, phone, sess };
}

function setUrgenceUI(data){
  const due = Number(data.messages_due || 0);
  const urgentBar = $("urgentBar");
  const urgentText = $("urgentText");
  const urgentBtn = $("urgentBtn");
  const dueBadge = $("dueBadge");
  const msgCard = $("msgCard");

  if(due > 0){
    urgentBar.style.display = "block";
    urgentText.textContent = `üö® ${due} message(s) √† envoyer MAINTENANT`;
    dueBadge.style.display = "inline-flex";
    dueBadge.textContent = `D√õ x${due}`;
    dueBadge.classList.add("duePulse");
    msgCard.classList.add("duePulse");

    if(navigator.vibrate) navigator.vibrate([80,40,80]);

    urgentBtn.onclick = () => { location.href = "./pulse.html"; };

    $("tempLevel").textContent = "üö® URGENCE : action imm√©diate";
    return true;
  } else {
    urgentBar.style.display = "none";
    dueBadge.style.display = "none";
    dueBadge.classList.remove("duePulse");
    msgCard.classList.remove("duePulse");
    return false;
  }
}

let __loading = false;

async function loadTemperature(){
  if(__loading) return;
  __loading = true;

  try{
    const sb = window.__digiy_sb__ || window.supa;

    if(!sb){
      $("status").textContent = "‚ö†Ô∏è Guard absent (supa)";
      return;
    }

    if(!navigator.onLine){
      $("status").textContent = "üì¥ Hors ligne";
      return;
    }

    const ident = requireSession();
    if(!ident) return;

    const { ownerId, phone } = ident;

    $("status").textContent = "‚è≥ Live‚Ä¶";

    // 1) LOC
    const rLoc = await sb.rpc("rpc_swarm_temperature_owner_v2", {
      p_owner: ownerId,
      p_phone: phone
    });

    if(rLoc.error){
      console.error(rLoc.error);
      $("status").textContent = "‚ùå Erreur RPC LOC";
      return;
    }

    const loc = rLoc.data || {};

    // 2) CAISSE (fallback)
    let caisse = { sales_today:0, turnover_today:0, avg_basket:0, top_payment_method:null, top_payment_method_n:0, last_sale_at:null };
    let caisseOk = true;

    const rCaisse = await sb.rpc("rpc_caisse_swarm_owner_v1", { p_owner: ownerId });
    if(rCaisse.error){
      caisseOk = false;
      console.warn("RPC caisse fail:", rCaisse.error);
    } else {
      caisse = rCaisse.data || caisse;
    }

    $("status").textContent = caisseOk ? "‚úÖ Live" : "‚úÖ Live (caisse: off)";

    // LOC KPIs
    $("kpiResa").textContent = loc.reservations ?? 0;
    $("kpiTomorrow").textContent = loc.tomorrow ?? 0;

    const bal = Number(loc.wallet_balance || 0);
    $("kpiWallet").textContent = moneyFCFA(bal);

    $("kpiMsg").textContent = loc.messages_new ?? 0;
    $("msgPlanned").textContent = loc.messages_new ?? 0;
    $("msgDue").textContent = loc.messages_due ?? 0;
    $("msgTomorrow").textContent = loc.messages_tomorrow ?? 0;

    // CAISSE KPIs
    $("kpiSalesToday").textContent = caisse.sales_today ?? 0;
    $("kpiTurnoverToday").textContent = moneyFCFA(caisse.turnover_today ?? 0);
    $("kpiAvgBasket").textContent = moneyFCFA(Math.round(caisse.avg_basket ?? 0));

    // Temp√©rature
    const isUrgent = setUrgenceUI(loc);
    if(!isUrgent){
      $("tempLevel").textContent = safeLabel(loc.label || "‚ùÑÔ∏è Calme");
    }

    // Meta
    const topPay = caisse.top_payment_method ? `${caisse.top_payment_method} (${caisse.top_payment_method_n||0})` : "‚Äî";
    const lastSale = fmtDate(caisse.last_sale_at);

    $("subTemp").textContent =
      `Wallet: ${moneyFCFA(bal)} FCFA ‚Ä¢ Msg: ${loc.messages_new ?? 0} (d√ª: ${loc.messages_due ?? 0}, demain: ${loc.messages_tomorrow ?? 0}) ‚Ä¢ ` +
      `Caisse: ${caisse.sales_today ?? 0} vente(s), CA ${moneyFCFA(caisse.turnover_today ?? 0)} ‚Ä¢ Top ${topPay} ‚Ä¢ Derni√®re vente ${lastSale} ‚Ä¢ Maj: ${nowLabel()}`;
  } finally {
    __loading = false;
  }
}

console.log("guard present?", !!(window.__digiy_sb__ || window.supa));
console.log("digiyGuard fn?", typeof window.digiyGuard);

// Boot + refresh
loadTemperature();
setInterval(loadTemperature, 60000);
document.addEventListener("visibilitychange", () => { if(!document.hidden) loadTemperature(); });
</script>

</body>
</html>
