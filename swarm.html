<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#061b14"/>
  <title>ü¶Ö DIGIY Pulse Swarm Manager</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ‚úÖ ton guard universel (celui qui exporte window.DIGIY_GUARD) -->
  <script src="./guard.js?v=1" defer></script>

  <style>
    :root{
      --bg:#061b14;
      --card:#0b2a1f;
      --line:rgba(255,255,255,.12);
      --text:#eafff1;
      --muted:rgba(234,255,241,.7);
      --gold:#facc15;
      --green:#22c55e;
      --orange:#f59e0b;
      --red:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,sans-serif;
      background:
        radial-gradient(circle at 20% 10%,rgba(250,204,21,.12),transparent 55%),
        radial-gradient(circle at 80% 90%,rgba(34,197,94,.10),transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:20px;
    }
    .wrap{max-width:1200px;margin:0 auto}

    header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px; flex-wrap:wrap; gap:12px;
    }
    .logo{font-size:28px;font-weight:900;color:var(--gold)}
    .backBtn{
      padding:10px 16px;border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:var(--text);text-decoration:none;font-weight:600;font-size:14px;
    }

    .section{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:20px;
      padding:20px;
      margin-bottom:20px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    .section h2{
      font-size:18px;font-weight:900;margin-bottom:16px;
      display:flex;align-items:center;gap:10px;
    }

    .statusCard{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }
    .stat{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      text-align:center;
    }
    .stat-label{font-size:13px;color:var(--muted);margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:900;color:var(--gold)}
    .stat-hint{font-size:12px;color:rgba(234,255,241,.5);margin-top:6px}

    .status-running{color:var(--green)}
    .status-stopped{color:var(--red)}

    .pulseList{display:flex;flex-direction:column;gap:12px}
    .pulseItem{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
    }
    .pulseIcon{font-size:24px}
    .pulseKind{font-weight:900;font-size:14px;color:var(--gold)}
    .pulsePhone{font-size:13px;color:var(--muted);margin-top:4px}
    .pulseMsg{
      font-size:12px;color:rgba(234,255,241,.6);
      margin-top:4px;max-width:520px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pulseMeta{font-size:12px;text-align:right}
    .pulseRetry{color:var(--orange);font-weight:700}
    .pulseError{color:var(--red);font-size:11px;margin-top:4px}

    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    .btn{
      padding:12px 18px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:var(--text);
      font-weight:900;font-size:14px;cursor:pointer;
      transition:all .2s;
    }
    .btn:hover{background:rgba(255,255,255,.15);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .logBox{
      background:rgba(0,0,0,.4);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:14px;
      font-family:ui-monospace,monospace;
      font-size:12px;
      max-height:300px;
      overflow-y:auto;
      line-height:1.6;
      color:rgba(234,255,241,.8);
    }
    .logBox div{margin-bottom:4px}

    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .loading{animation:blink 1.5s infinite}

    .smallNote{
      margin-top:10px;
      font-size:12px;
      color:rgba(234,255,241,.65);
      line-height:1.45;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      font-size:12px;
      font-weight:900;
      color:rgba(234,255,241,.9);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">ü¶Ö DIGIY PULSE SWARM</div>
        <div class="smallNote">
          Supervision temps r√©el : worker + pulses pending.<br/>
          <span class="badge" id="whoBadge">‚è≥ Session‚Ä¶</span>
        </div>
      </div>
      <a class="backBtn" href="./">‚Üê HUB</a>
    </header>

    <div class="section">
      <h2>üìä Worker Status</h2>
      <div class="statusCard">
        <div class="stat">
          <div class="stat-label">Status</div>
          <div class="stat-value" id="workerStatus">‚Äî</div>
          <div class="stat-hint" id="workerHint">Chargement...</div>
        </div>
        <div class="stat">
          <div class="stat-label">Uptime</div>
          <div class="stat-value" id="workerUptime">‚Äî</div>
          <div class="stat-hint">Temps actif</div>
        </div>
        <div class="stat">
          <div class="stat-label">Pulses trait√©s</div>
          <div class="stat-value" id="workerProcessed">‚Äî</div>
          <div class="stat-hint">Total envoy√©s</div>
        </div>
        <div class="stat">
          <div class="stat-label">Last ping</div>
          <div class="stat-value" id="workerPing">‚Äî</div>
          <div class="stat-hint">Derni√®re activit√©</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnRefresh">üîÑ Rafra√Æchir</button>
        <button class="btn" id="btnDeploy" disabled title="√Ä brancher via API/MCP">üöÄ Deploy Worker</button>
        <button class="btn" id="btnRestart" disabled title="√Ä brancher via API/MCP">‚ôªÔ∏è Restart Worker</button>
        <button class="btn" id="btnLogs" disabled title="√Ä brancher via API/MCP">üìù View Logs</button>
      </div>

      <div class="smallNote" id="noteRpc">
        RPC attendues : <b>get_worker_status</b>, <b>get_pending_pulses</b>.
        Si non dispo, on affiche une erreur propre.
      </div>
    </div>

    <div class="section">
      <h2>üìã Pulses en attente (<span id="pulseCount">0</span>)</h2>
      <div class="pulseList" id="pulseList">
        <div class="loading">Chargement...</div>
      </div>
    </div>

    <div class="section" style="display:none" id="logSection">
      <h2>üìù Logs</h2>
      <div class="logBox" id="logBox">
        <div>Logs non disponibles (n√©cessite int√©gration API/MCP)</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  // ‚úÖ Mets tes cl√©s ici (les m√™mes que partout)
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  let sb = null;
  let refreshInterval = null;

  function formatUptime(seconds){
    if(!seconds && seconds !== 0) return "‚Äî";
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return `${h}h ${m}m`;
  }

  function formatTimeAgo(isoDate){
    if(!isoDate) return "‚Äî";
    const diff = Math.floor((Date.now() - new Date(isoDate).getTime()) / 1000);
    if(!isFinite(diff)) return "‚Äî";
    if(diff < 60) return `${diff}s`;
    if(diff < 3600) return `${Math.floor(diff/60)}m`;
    return `${Math.floor(diff/3600)}h`;
  }

  function setWorkerStopped(msg){
    $('workerStatus').textContent = 'üî¥';
    $('workerStatus').className = 'stat-value status-stopped';
    $('workerHint').textContent = msg || 'Worker non d√©marr√©';
    $('workerUptime').textContent = '‚Äî';
    $('workerProcessed').textContent = '‚Äî';
    $('workerPing').textContent = '‚Äî';
  }

  async function loadWorkerStatus(){
    try{
      const {data, error} = await sb.rpc('get_worker_status', { p_worker_type: 'pulse_loc' });
      if(error) throw error;

      if(!data || data.length === 0){
        setWorkerStopped('Aucune entr√©e status');
        return;
      }

      const w = data[0];
      const isAlive = !!w.is_alive;

      $('workerStatus').textContent = isAlive ? 'üü¢' : 'üî¥';
      $('workerStatus').className = isAlive ? 'stat-value status-running' : 'stat-value status-stopped';
      $('workerHint').textContent = isAlive ? 'Running' : 'Stopped';

      $('workerUptime').textContent = formatUptime(w.uptime_seconds);
      $('workerProcessed').textContent = (w.pulses_processed ?? 0);
      $('workerPing').textContent = formatTimeAgo(w.last_ping);

    }catch(err){
      console.error('loadWorkerStatus error:', err);
      setWorkerStopped('Erreur RPC / permissions');
    }
  }

  async function loadPendingPulses(){
    try{
      const {data, error} = await sb.rpc('get_pending_pulses', { p_limit: 20 });
      if(error) throw error;

      $('pulseCount').textContent = data?.length || 0;

      const list = $('pulseList');
      if(!data || data.length === 0){
        list.innerHTML = '<div style="text-align:center;color:rgba(234,255,241,.5);padding:20px">Aucun pulse en attente üéâ</div>';
        return;
      }

      list.innerHTML = data.map(p => {
        const retryIn = p.next_try_at ? formatTimeAgo(p.next_try_at) : '';
        const icon = (p.kind === 'arrival') ? 'üì•' : (p.kind === 'departure') ? 'üì§' : '‚ö°';
        return `
          <div class="pulseItem">
            <div class="pulseIcon">${icon}</div>
            <div class="pulseInfo">
              <div class="pulseKind">${(p.kind || 'pulse')}</div>
              <div class="pulsePhone">${p.phone || '‚Äî'}</div>
              <div class="pulseMsg">${p.message || '‚Äî'}</div>
              ${p.last_error ? `<div class="pulseError">‚ùå ${escapeHtml(p.last_error)}</div>` : ''}
            </div>
            <div class="pulseMeta">
              <div>Attempt ${p.attempts || 1}</div>
              ${p.next_try_at ? `<div class="pulseRetry">Retry ${retryIn}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

    }catch(err){
      console.error('loadPendingPulses error:', err);
      $('pulseList').innerHTML = '<div style="color:var(--red)">Erreur chargement pulses (RPC / permissions)</div>';
    }
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function refresh(){
    await Promise.all([ loadWorkerStatus(), loadPendingPulses() ]);
  }

  async function ensureGuard(){
    // ‚úÖ On attend que guard.js soit charg√© (defer)
    for(let i=0;i<30;i++){
      if(window.DIGIY_GUARD && window.DIGIY_GUARD.boot) return true;
      await new Promise(r => setTimeout(r, 50));
    }
    return false;
  }

  async function main(){
    // ‚úÖ Guard
    const okGuard = await ensureGuard();
    if(!okGuard){
      alert("guard.js requis (window.DIGIY_GUARD introuvable)");
      return;
    }

    // Ici : page admin / swarm ‚Üí on exige une session
    // (si tu veux une porte sp√©ciale admin, on la fera apr√®s)
    const boot = await window.DIGIY_GUARD.boot({ login: "./pin.html" });
    if(!boot?.ok) return;

    const sess = boot.session || window.DIGIY_GUARD.getSession?.();
    const who = sess?.slug ? `üë§ ${sess.slug}` : "üë§ Session";
    $('whoBadge').textContent = who;

    // ‚úÖ Supabase
    if(window.__digiy_sb__){
      sb = window.__digiy_sb__;
    }else{
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.__digiy_sb__ = sb;
    }

    // Load
    await refresh();

    // Auto-refresh every 15s
    refreshInterval = setInterval(refresh, 15000);

    // Actions
    $('btnRefresh').addEventListener('click', refresh);

    $('btnLogs').addEventListener('click', () => {
      $('logSection').style.display = 'block';
    });
  }

  main().catch(err => {
    console.error('main error:', err);
    alert('Erreur initialisation Swarm Manager');
  });
})();
</script>
</body>
</html>
